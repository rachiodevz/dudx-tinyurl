<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title>TinyURL Generator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            body {
                font-family: system-ui, sans-serif;
                background: #f6f8fb;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                padding: 20px;
            }
            .user-bar {
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .user-info {
                display: flex;
                align-items: center;
                gap: 10px;
                background: white;
                padding: 8px 15px;
                border-radius: 20px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .user-photo {
                width: 32px;
                height: 32px;
                border-radius: 50%;
            }
            .user-name {
                font-size: 14px;
                font-weight: 500;
            }
            .logout-btn {
                background: #dc3545;
                color: white;
                padding: 8px 15px;
                font-size: 13px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            .logout-btn:hover {
                background: #c82333;
            }
            .login-btn {
                background: white;
                color: #333;
                padding: 10px 20px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .login-btn:hover {
                background: #f8f9fa;
            }
            .card {
                background: white;
                padding: 30px;
                border-radius: 16px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                width: 360px;
                text-align: center;
            }
            .login-container {
                text-align: center;
                background: white;
                padding: 40px;
                border-radius: 16px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .hidden {
                display: none;
            }
            input[type="text"] {
                width: 100%;
                padding: 10px;
                font-size: 15px;
                border-radius: 8px;
                border: 1px solid #ccc;
                margin-bottom: 15px;
            }
            button {
                background: #007bff;
                color: white;
                padding: 10px 20px;
                font-size: 15px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            button:hover {
                background: #0056b3;
            }
            .result {
                margin-top: 20px;
                font-size: 14px;
                color: #333;
            }
            .shortlink {
                display: inline-block;
                background: #eef6ff;
                padding: 12px 16px;
                border-radius: 8px;
                margin-top: 8px;
                word-break: break-all;
                transition: all 0.2s;
                border: 2px solid transparent;
            }
            .shortlink:hover {
                background: #d4e9ff;
                border-color: #007bff;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
            }
            .shortlink a {
                color: #007bff;
                text-decoration: none;
                font-weight: 600;
                font-size: 16px;
            }
            .shortlink a:hover {
                text-decoration: underline;
            }
            .list {
                margin-top: 25px;
                text-align: left;
                font-size: 13px;
            }
            .list-item {
                margin-bottom: 8px;
            }
        </style>
    </head>
    <body>
        <!-- User Bar -->
        <div class="user-bar hidden" id="userBar">
            <a
                href="/my-urls"
                style="
                    text-decoration: none;
                    color: #007bff;
                    font-size: 14px;
                    font-weight: 500;
                "
                >üîó URL ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a
            >
            <a
                href="/admin"
                id="adminLink"
                class="hidden"
                style="
                    text-decoration: none;
                    color: #007bff;
                    font-size: 14px;
                    font-weight: 500;
                "
                >üìä Admin</a
            >
            <div class="user-info">
                <img class="user-photo" id="userPhoto" src="" alt="User" />
                <span class="user-name" id="userName"></span>
            </div>
            <button class="logout-btn" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <!-- Login Screen -->
        <div class="login-container" id="loginContainer">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TinyURL</p>
            <button
                class="login-btn"
                onclick="window.location.href='/auth/google'"
            >
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path
                        fill="#4285F4"
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                    />
                    <path
                        fill="#34A853"
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
                    />
                    <path
                        fill="#FBBC05"
                        d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
                    />
                    <path
                        fill="#EA4335"
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                    />
                </svg>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>

        <!-- Main App -->
        <div class="card hidden" id="mainApp">
            <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô</h2>
            <input
                type="text"
                id="urlInput"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
            />
            <input
                type="text"
                id="customCodeInput"
                placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÄ‡∏ä‡πà‡∏ô: meeting, docs2024"
                style="margin-top: 10px"
            />
            <div
                style="
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                    margin-left: 5px;
                "
            >
                üí° ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á =
                ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 3-20 ‡∏ï‡∏±‡∏ß
            </div>
            <input
                type="text"
                id="memoInput"
                placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å note (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÄ‡∏ä‡πà‡∏ô: ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô, ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ"
                style="margin-top: 10px"
            />
            <button id="shortenBtn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
            <div class="result" id="result"></div>
            <div class="list" id="list"></div>
        </div>

        <script>
            const input = document.getElementById("urlInput");
            const customCodeInput = document.getElementById("customCodeInput");
            const btn = document.getElementById("shortenBtn");
            const result = document.getElementById("result");
            const list = document.getElementById("list");
            const loginContainer = document.getElementById("loginContainer");
            const mainApp = document.getElementById("mainApp");
            const userBar = document.getElementById("userBar");
            const userName = document.getElementById("userName");
            const userPhoto = document.getElementById("userPhoto");
            const logoutBtn = document.getElementById("logoutBtn");

            const history = [];

            // Check authentication on page load
            async function checkAuth() {
                try {
                    const res = await fetch("/auth/user");
                    if (res.ok) {
                        const user = await res.json();
                        // User is authenticated
                        loginContainer.classList.add("hidden");
                        mainApp.classList.remove("hidden");
                        userBar.classList.remove("hidden");
                        userName.textContent = user.name;
                        userPhoto.src = user.photo;

                        // Show admin link only for ADMIN or SUPER_ADMIN
                        const adminLink = document.getElementById("adminLink");
                        if (
                            user.role === "ADMIN" ||
                            user.role === "SUPER_ADMIN"
                        ) {
                            adminLink.classList.remove("hidden");
                        } else {
                            adminLink.classList.add("hidden");
                        }
                    } else {
                        // User is not authenticated
                        loginContainer.classList.remove("hidden");
                        mainApp.classList.add("hidden");
                        userBar.classList.add("hidden");
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    loginContainer.classList.remove("hidden");
                    mainApp.classList.add("hidden");
                    userBar.classList.add("hidden");
                }
            }

            // Logout handler
            logoutBtn.addEventListener("click", () => {
                window.location.href = "/auth/logout";
            });

            // Check auth on load
            checkAuth();

            btn.addEventListener("click", async () => {
                const url = input.value.trim();
                const memo = document.getElementById("memoInput").value.trim();
                const customCode = customCodeInput.value.trim();

                if (!url) {
                    result.innerHTML = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô";
                    return;
                }

                result.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå...";
                try {
                    const requestBody = { url, memo };
                    if (customCode) {
                        requestBody.customCode = customCode;
                    }

                    const res = await fetch("/api/shorten", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody),
                    });
                    const data = await res.json();
                    if (data.short) {
                        result.innerHTML = `
            ‚úÖ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:<br>
            <div class="shortlink">
              <a href="${data.short}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 600; font-size: 16px;">${data.short}</a>
            </div>
            <div style="margin-top: 12px; font-size: 13px; color: #666;">
              üëÜ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠
              <button onclick="navigator.clipboard.writeText('${data.short}')" style="margin-left: 5px;">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
            </div>
          `;
                        history.unshift(data);
                        renderList();
                        // Clear inputs after success
                        input.value = "";
                        customCodeInput.value = "";
                        document.getElementById("memoInput").value = "";
                    } else {
                        result.innerHTML = "‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                    }
                } catch (e) {
                    result.innerHTML =
                        "‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå";
                    // Check if it's an auth error
                    if (e.message && e.message.includes("401")) {
                        result.innerHTML = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà";
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                }
            });

            function renderList() {
                list.innerHTML = history
                    .map(
                        (h) =>
                            `<div class="list-item">üîó <a href="${h.short}" target="_blank">${h.short}</a></div>`,
                    )
                    .join("");
            }
        </script>
    </body>
</html>
