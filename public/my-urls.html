<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - TinyURL</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: system-ui, sans-serif;
                background: #f6f8fb;
                min-height: 100vh;
                padding: 20px;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .header {
                background: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .header h1 {
                font-size: 24px;
                color: #333;
            }
            .nav {
                display: flex;
                gap: 15px;
                align-items: center;
            }
            .nav a {
                color: #007bff;
                text-decoration: none;
                font-size: 14px;
                padding: 8px 15px;
                border-radius: 8px;
                transition: background 0.2s;
            }
            .nav a:hover {
                background: #f0f0f0;
            }
            .user-info {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px 15px;
                background: #f8f9fa;
                border-radius: 20px;
            }
            .user-photo {
                width: 32px;
                height: 32px;
                border-radius: 50%;
            }
            .logout-btn {
                background: #dc3545;
                color: white;
                padding: 8px 15px;
                font-size: 13px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            .logout-btn:hover {
                background: #c82333;
            }
            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            .stat-card {
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .stat-card h3 {
                font-size: 14px;
                color: #666;
                margin-bottom: 10px;
            }
            .stat-card .number {
                font-size: 32px;
                font-weight: bold;
                color: #007bff;
            }
            .content {
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .search-box {
                margin-bottom: 20px;
            }
            .search-box input {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            thead {
                background: #f8f9fa;
            }
            th {
                padding: 12px;
                text-align: left;
                font-size: 13px;
                font-weight: 600;
                color: #666;
                border-bottom: 2px solid #dee2e6;
            }
            td {
                padding: 12px;
                font-size: 14px;
                border-bottom: 1px solid #dee2e6;
            }
            tr:hover {
                background: #f8f9fa;
            }
            .code-cell {
                font-family: system-ui, sans-serif;
                min-width: 120px;
            }
            .url-cell {
                max-width: 300px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .url-cell a {
                color: #333;
                text-decoration: none;
            }
            .url-cell a:hover {
                text-decoration: underline;
            }
            .date-cell {
                color: #666;
                font-size: 13px;
            }
            .actions {
                display: flex;
                gap: 8px;
            }
            .btn {
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s;
            }
            .btn-edit {
                background: #ffc107;
                color: #000;
            }
            .btn-edit:hover {
                background: #e0a800;
            }
            .btn-delete {
                background: #dc3545;
                color: white;
            }
            .btn-delete:hover {
                background: #c82333;
            }
            .btn-copy {
                background: #007bff;
                color: white;
            }
            .btn-copy:hover {
                background: #0056b3;
            }
            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }
            .empty {
                text-align: center;
                padding: 40px;
                color: #999;
            }
            .login-container {
                max-width: 400px;
                margin: 100px auto;
                background: white;
                padding: 40px;
                border-radius: 16px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .login-btn {
                background: white;
                color: #333;
                padding: 12px 24px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .login-btn:hover {
                background: #f8f9fa;
            }
            .hidden {
                display: none;
            }

            /* Modal styles */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                justify-content: center;
                align-items: center;
            }
            .modal.show {
                display: flex;
            }
            .modal-content {
                background: white;
                padding: 30px;
                border-radius: 12px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            }
            .modal-header {
                margin-bottom: 20px;
            }
            .modal-header h2 {
                font-size: 20px;
                color: #333;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-size: 14px;
                font-weight: 500;
                color: #555;
            }
            .form-group input {
                width: 100%;
                padding: 10px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            .form-group .hint {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
            .modal-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                margin-top: 20px;
            }
            .btn-primary {
                background: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
            }
            .btn-primary:hover {
                background: #0056b3;
            }
            .btn-secondary {
                background: #6c757d;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
            }
            .btn-secondary:hover {
                background: #5a6268;
            }
            .error-msg {
                color: #dc3545;
                font-size: 13px;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <!-- Login Screen -->
        <div class="login-container hidden" id="loginContainer">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
            <p style="margin: 20px 0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <button
                class="login-btn"
                onclick="window.location.href='/auth/google'"
            >
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path
                        fill="#4285F4"
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                    />
                    <path
                        fill="#34A853"
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
                    />
                    <path
                        fill="#FBBC05"
                        d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
                    />
                    <path
                        fill="#EA4335"
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                    />
                </svg>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>

        <!-- Main Panel -->
        <div class="container hidden" id="mainPanel">
            <div class="header">
                <h1>üîó ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
                <div class="nav">
                    <a href="/">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
                    <a href="/admin" id="adminLink" class="hidden">üìä Admin</a>
                    <div class="user-info">
                        <img class="user-photo" id="userPhoto" src="" alt="" />
                        <span id="userName"></span>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3>URL ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="number" id="totalUrls">0</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div class="number" id="todayUrls">0</div>
                </div>
                <div class="stat-card">
                    <h3>üëÅÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="number" id="totalClicks">0</div>
                </div>
                <div class="stat-card">
                    <h3>üìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/URL</h3>
                    <div class="number" id="avgClicks">0</div>
                </div>
                <div class="stat-card">
                    <h3>üî• ‡∏°‡∏≤‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                    <div
                        class="number"
                        style="font-size: 18px; color: #dc3545"
                        id="topUrl"
                    >
                        -
                    </div>
                </div>
                <div class="stat-card">
                    <h3>‚è∞ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h3>
                    <div
                        class="number"
                        style="font-size: 18px; color: #ffa500"
                        id="expiringSoon"
                    >
                        0
                    </div>
                </div>
            </div>

            <div class="content">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    "
                >
                    <div
                        class="search-box"
                        style="flex: 1; margin: 0; margin-right: 10px"
                    >
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ URL ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™..."
                        />
                    </div>
                    <div style="display: flex; gap: 10px">
                        <button
                            onclick="exportCSV()"
                            style="
                                padding: 10px 20px;
                                background: #28a745;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            "
                        >
                            üì• CSV
                        </button>
                        <button
                            onclick="exportJSON()"
                            style="
                                padding: 10px 20px;
                                background: #17a2b8;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            "
                        >
                            üì• JSON
                        </button>
                    </div>
                </div>

                <div id="tableContainer">
                    <div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL</h2>
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô</label>
                    <input type="text" id="editCode" />
                    <div class="hint">
                        ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (3-20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
                    </div>
                </div>
                <div class="form-group">
                    <label>URL ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                    <input type="text" id="editTarget" />
                </div>
                <div class="form-group">
                    <label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</label>
                    <input
                        type="text"
                        id="editMemo"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô, ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ"
                    />
                </div>
                <div class="error-msg" id="editError"></div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeEditModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button class="btn-primary" onclick="saveEdit()">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div class="modal" id="qrModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üì± QR Code</h2>
                </div>
                <div style="text-align: center; padding: 20px">
                    <img
                        id="qrImage"
                        src=""
                        alt="QR Code"
                        style="max-width: 100%; border-radius: 8px"
                    />
                    <div style="margin-top: 15px; font-size: 14px; color: #666">
                        <p id="qrUrl" style="word-break: break-all"></p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeQRModal()">
                        ‡∏õ‡∏¥‡∏î
                    </button>
                    <button class="btn-primary" onclick="downloadQR()">
                        üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </button>
                </div>
            </div>
        </div>

        <script>
            let allUrls = [];
            let filteredUrls = [];
            let currentEditCode = null;
            let currentQRData = null;

            // Check authentication
            async function checkAuth() {
                try {
                    const res = await fetch("/auth/user");
                    if (res.ok) {
                        const user = await res.json();
                        document
                            .getElementById("loginContainer")
                            .classList.add("hidden");
                        document
                            .getElementById("mainPanel")
                            .classList.remove("hidden");
                        document.getElementById("userName").textContent =
                            user.name;
                        document.getElementById("userPhoto").src = user.photo;

                        // Show admin link only for ADMIN or SUPER_ADMIN
                        const adminLink = document.getElementById("adminLink");
                        if (
                            user.role === "ADMIN" ||
                            user.role === "SUPER_ADMIN"
                        ) {
                            adminLink.classList.remove("hidden");
                        }

                        loadUrls();
                    } else {
                        document
                            .getElementById("loginContainer")
                            .classList.remove("hidden");
                        document
                            .getElementById("mainPanel")
                            .classList.add("hidden");
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    document
                        .getElementById("loginContainer")
                        .classList.remove("hidden");
                    document
                        .getElementById("mainPanel")
                        .classList.add("hidden");
                }
            }

            // Logout
            document
                .getElementById("logoutBtn")
                ?.addEventListener("click", () => {
                    window.location.href = "/auth/logout";
                });

            // Load user's URLs from API
            async function loadUrls() {
                try {
                    const res = await fetch("/api/my-urls");
                    console.log("Response status:", res.status);
                    if (res.ok) {
                        allUrls = await res.json();
                        console.log("Loaded URLs:", allUrls);
                        console.log("Number of URLs:", allUrls.length);
                        filteredUrls = allUrls;
                        updateStats();
                        renderTable();
                    } else {
                        const errorText = await res.text();
                        console.error("Error response:", errorText);
                        document.getElementById("tableContainer").innerHTML =
                            '<div class="empty">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
                    }
                } catch (e) {
                    console.error("Failed to load URLs:", e);
                    document.getElementById("tableContainer").innerHTML =
                        '<div class="empty">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                }
            }

            // Update statistics
            function updateStats() {
                const total = allUrls.length;
                const today = allUrls.filter((url) => {
                    const created = new Date(url.created_at);
                    const now = new Date();
                    return (
                        created.getDate() === now.getDate() &&
                        created.getMonth() === now.getMonth() &&
                        created.getFullYear() === now.getFullYear()
                    );
                }).length;

                // Calculate total clicks
                const totalClicks = allUrls.reduce(
                    (sum, url) => sum + (url.clicks || 0),
                    0,
                );

                // Calculate average clicks
                const avgClicks =
                    total > 0 ? Math.round(totalClicks / total) : 0;

                // Find top URL
                const topUrl =
                    allUrls.length > 0
                        ? allUrls.reduce((max, url) =>
                              (url.clicks || 0) > (max.clicks || 0) ? url : max,
                          )
                        : null;

                // Count expiring soon (within 7 days)
                const now = new Date();
                const expiringSoon = allUrls.filter((url) => {
                    if (!url.expires_at) return false;
                    const expiryDate = new Date(url.expires_at);
                    const diffDays = Math.ceil((expiryDate - now) / 86400000);
                    return diffDays > 0 && diffDays <= 7;
                }).length;

                document.getElementById("totalUrls").textContent = total;
                document.getElementById("todayUrls").textContent = today;
                document.getElementById("totalClicks").textContent =
                    totalClicks.toLocaleString();
                document.getElementById("avgClicks").textContent = avgClicks;
                document.getElementById("topUrl").textContent = topUrl
                    ? topUrl.code
                    : "-";
                document.getElementById("expiringSoon").textContent =
                    expiringSoon;
            }

            // Render table
            function renderTable() {
                const container = document.getElementById("tableContainer");

                if (filteredUrls.length === 0) {
                    container.innerHTML =
                        '<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• URL<br><br><a href="/" style="color: #007bff;">‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</a></div>';
                    return;
                }

                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Short Link</th>
                                <th>URL ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                                <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                <th>üëÅÔ∏è Clicks</th>
                                <th>‚è∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUrls
                                .map(
                                    (url) => `
                                <tr>
                                    <td class="code-cell">
                                        <a href="${window.location.origin}/${url.code}" target="_blank"
                                           style="color: #007bff; text-decoration: none; font-weight: 600; font-family: 'Courier New', monospace; font-size: 14px;"
                                           onmouseover="this.style.textDecoration='underline'"
                                           onmouseout="this.style.textDecoration='none'"
                                           title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${window.location.origin}/${url.code}">
                                            üîó ${url.code}
                                        </a>
                                    </td>
                                    <td class="url-cell">
                                        <a href="${url.target}" target="_blank" title="${url.target}">
                                            ${url.target}
                                        </a>
                                    </td>
                                    <td class="date-cell">${url.memo || "-"}</td>
                                    <td class="date-cell" style="text-align: center; font-weight: 600; color: #007bff;">
                                        ${url.clicks || 0}
                                    </td>
                                    <td class="date-cell" style="text-align: center;">
                                        ${getExpiryStatus(url)}
                                    </td>
                                    <td class="date-cell">${formatDate(url.created_at)}</td>
                                    <td>
                                        <div class="actions">
                                            <button class="btn btn-copy" onclick="copyUrl('${window.location.origin}/${url.code}')">
                                                üìã
                                            </button>
                                            <button class="btn btn-copy" onclick="showQRCode('${url.code}')" style="background: #17a2b8;">
                                                üì± QR
                                            </button>
                                            <button class="btn btn-edit" onclick="openEditModal('${url.code}')">
                                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </button>
                                            <button class="btn btn-delete" onclick="deleteUrl('${url.code}')">
                                                üóëÔ∏è ‡∏•‡∏ö
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;

                container.innerHTML = table;
            }

            // Get expiry status
            function getExpiryStatus(url) {
                if (!url.expires_at) {
                    return '<span style="color: #28a745;">‚úÖ ‡∏ñ‡∏≤‡∏ß‡∏£</span>';
                }

                const now = new Date();
                const expiryDate = new Date(url.expires_at);
                const diffMs = expiryDate - now;
                const diffDays = Math.ceil(diffMs / 86400000);

                if (diffMs <= 0) {
                    return '<span style="color: #dc3545; font-weight: 600;">‚ùå ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>';
                } else if (diffDays <= 1) {
                    return '<span style="color: #ff6b6b;">‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ < 1 ‡∏ß‡∏±‡∏ô</span>';
                } else if (diffDays <= 7) {
                    return `<span style="color: #ffa500;">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diffDays} ‡∏ß‡∏±‡∏ô</span>`;
                } else {
                    return `<span style="color: #666;">‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diffDays} ‡∏ß‡∏±‡∏ô</span>`;
                }
            }

            // Format date
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
                if (diffMins < 60) return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffHours < 24) return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffDays < 7) return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;

                return date.toLocaleDateString("th-TH", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            // Copy URL to clipboard
            function copyUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    alert("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!");
                });
            }

            // Open edit modal
            function openEditModal(code) {
                const url = allUrls.find((u) => u.code === code);
                if (!url) return;

                currentEditCode = code;
                document.getElementById("editCode").value = url.code;
                document.getElementById("editTarget").value = url.target;
                document.getElementById("editMemo").value = url.memo || "";
                document.getElementById("editError").textContent = "";
                document.getElementById("editModal").classList.add("show");
            }

            // Close edit modal
            function closeEditModal() {
                document.getElementById("editModal").classList.remove("show");
                currentEditCode = null;
            }

            // Save edit
            async function saveEdit() {
                const newCode = document
                    .getElementById("editCode")
                    .value.trim();
                const target = document
                    .getElementById("editTarget")
                    .value.trim();
                const memo = document.getElementById("editMemo").value.trim();
                const errorDiv = document.getElementById("editError");

                if (!newCode || !target) {
                    errorDiv.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô";
                    return;
                }

                try {
                    const res = await fetch(`/api/urls/${currentEditCode}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ newCode, target, memo }),
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                        closeEditModal();
                        loadUrls();
                    } else {
                        errorDiv.textContent = data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                    }
                } catch (e) {
                    console.error("Edit failed:", e);
                    errorDiv.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
                }
            }

            // Show QR Code
            async function showQRCode(code) {
                try {
                    const res = await fetch(`/api/qr/${code}`);
                    const data = await res.json();

                    if (res.ok) {
                        currentQRData = data.qrCode;
                        document.getElementById("qrImage").src = data.qrCode;
                        document.getElementById("qrUrl").textContent =
                            `${window.location.origin}/${code}`;
                        document
                            .getElementById("qrModal")
                            .classList.add("show");
                    } else {
                        alert("‚ùå " + data.error);
                    }
                } catch (e) {
                    console.error("QR generation failed:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                }
            }

            // Close QR Modal
            function closeQRModal() {
                document.getElementById("qrModal").classList.remove("show");
                currentQRData = null;
            }

            // Download QR Code
            function downloadQR() {
                if (!currentQRData) return;

                const link = document.createElement("a");
                link.href = currentQRData;
                link.download = "qrcode.png";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert("‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR Code ‡πÅ‡∏•‡πâ‡∏ß!");
            }

            // Export to CSV
            function exportCSV() {
                if (allUrls.length === 0) {
                    alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export");
                    return;
                }

                const headers = [
                    "Code",
                    "Target URL",
                    "Memo",
                    "Clicks",
                    "Expires At",
                    "Created At",
                ];
                const rows = allUrls.map((url) => [
                    url.code,
                    url.target,
                    url.memo || "",
                    url.clicks || 0,
                    url.expires_at || "",
                    url.created_at,
                ]);

                let csv = headers.join(",") + "\n";
                rows.forEach((row) => {
                    csv += row.map((field) => `"${field}"`).join(",") + "\n";
                });

                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `my-urls-${new Date().toISOString().split("T")[0]}.csv`;
                link.click();

                alert("‚úÖ Export CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            }

            // Export to JSON
            function exportJSON() {
                if (allUrls.length === 0) {
                    alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export");
                    return;
                }

                const data = JSON.stringify(allUrls, null, 2);
                const blob = new Blob([data], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `my-urls-${new Date().toISOString().split("T")[0]}.json`;
                link.click();

                alert("‚úÖ Export JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            }

            // Delete URL
            async function deleteUrl(code) {
                if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö URL ‡∏ô‡∏µ‡πâ?")) {
                    return;
                }

                try {
                    const res = await fetch(`/api/urls/${code}`, {
                        method: "DELETE",
                    });

                    if (res.ok) {
                        alert("‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                        loadUrls();
                    } else {
                        const data = await res.json();
                        alert("‚ùå " + (data.error || "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
                    }
                } catch (e) {
                    console.error("Delete failed:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
                }
            }

            // Search functionality
            document
                .getElementById("searchInput")
                ?.addEventListener("input", (e) => {
                    const query = e.target.value.toLowerCase();
                    filteredUrls = allUrls.filter((url) => {
                        return (
                            url.code.toLowerCase().includes(query) ||
                            url.target.toLowerCase().includes(query)
                        );
                    });
                    renderTable();
                });

            // Close modal on outside click
            document
                .getElementById("editModal")
                .addEventListener("click", (e) => {
                    if (e.target.id === "editModal") {
                        closeEditModal();
                    }
                });

            // Initialize
            checkAuth();
        </script>
    </body>
</html>
