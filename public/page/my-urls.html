<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title data-i18n="myUrls.title">üîó Manage My URLs - TinyURL</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/css/navbar.css" />
        <link rel="stylesheet" href="/css/my-urls.css" />
    </head>
    <body>
        <!-- Login Screen -->
        <div class="login-container hidden" id="loginContainer">
            <div
                style="
                    display: flex;
                    gap: 8px;
                    justify-content: center;
                    margin-bottom: 20px;
                "
            >
                <button
                    onclick="window.i18n.setLang('th')"
                    id="langBtnTh1"
                    class="lang-btn"
                    style="padding: 5px 10px; font-size: 13px; font-weight: 600"
                >
                    TH
                </button>
                <button
                    onclick="window.i18n.setLang('en')"
                    id="langBtnEn1"
                    class="lang-btn"
                    style="padding: 5px 10px; font-size: 13px; font-weight: 600"
                >
                    EN
                </button>
            </div>
            <h2 data-i18n="login.welcome">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
            <p style="margin: 20px 0" data-i18n="myUrls.loginDescription"></p>
            <button
                class="login-btn"
                onclick="window.location.href='/auth/google'"
            >
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path
                        fill="#4285F4"
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                    />
                    <path
                        fill="#34A853"
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
                    />
                    <path
                        fill="#FBBC05"
                        d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
                    />
                    <path
                        fill="#EA4335"
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                    />
                </svg>
                <span data-i18n="button.loginGoogle"></span>
            </button>
        </div>

        <!-- Main Panel -->
        <div class="container hidden" id="mainPanel">
            <div class="header">
                <h1 data-i18n="myUrls.title"></h1>
                <div class="nav">
                    <a href="/" data-i18n="nav.home"></a>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3 data-i18n="stats.totalUrls"></h3>
                    <div class="number" id="totalUrls">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-i18n="stats.createdToday"></h3>
                    <div class="number" id="todayUrls">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-i18n="stats.totalClicks">üëÅÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="number" id="totalClicks">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-i18n="stats.avgClicks">üìä ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/URL</h3>
                    <div class="number" id="avgClicks">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-i18n="stats.topUrl">üî• ‡∏°‡∏≤‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                    <div
                        class="number"
                        style="font-size: 18px; color: #dc3545"
                        id="topUrl"
                    >
                        -
                    </div>
                </div>
                <div class="stat-card">
                    <h3 data-i18n="stats.expiringSoon">‚è∞ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h3>
                    <div
                        class="number"
                        style="font-size: 18px; color: #ffa500"
                        id="expiringSoon"
                    >
                        0
                    </div>
                </div>
            </div>

            <div class="content">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    "
                >
                    <div
                        class="search-box"
                        style="flex: 1; margin: 0; margin-right: 10px"
                    >
                        <input
                            type="text"
                            id="searchInput"
                            data-i18n-placeholder="placeholder.search"
                            placeholder=""
                        />
                    </div>
                    <div style="display: flex; gap: 10px">
                        <button
                            onclick="refreshData()"
                            style="
                                padding: 10px 20px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            "
                            data-i18n="button.refresh"
                        >
                            üîÑ Refresh
                        </button>
                        <button
                            onclick="exportCSV()"
                            style="
                                padding: 10px 20px;
                                background: #28a745;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            "
                            data-i18n="button.exportCSV"
                        >
                            üì• CSV
                        </button>
                        <button
                            onclick="exportJSON()"
                            style="
                                padding: 10px 20px;
                                background: #17a2b8;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            "
                            data-i18n="button.exportJSON"
                        >
                            üì• JSON
                        </button>
                    </div>
                </div>

                <div id="tableContainer">
                    <div class="loading" data-i18n="message.loading"></div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 data-i18n="modal.editTitle"></h2>
                </div>
                <div class="form-group">
                    <label data-i18n="label.shortCode"></label>
                    <input type="text" id="editCode" />
                    <div class="hint" data-i18n="hint.codeFormat"></div>
                </div>
                <div class="form-group">
                    <label data-i18n="label.targetUrl"></label>
                    <input type="text" id="editTarget" />
                </div>
                <div class="form-group">
                    <label data-i18n="label.memo"></label>
                    <input
                        type="text"
                        id="editMemo"
                        data-i18n-placeholder="placeholder.memo"
                        placeholder=""
                    />
                </div>
                <div class="error-msg" id="editError"></div>
                <div class="modal-actions">
                    <button
                        class="btn-secondary"
                        onclick="closeEditModal()"
                        data-i18n="button.cancel"
                    ></button>
                    <button
                        class="btn-primary"
                        onclick="saveEdit()"
                        data-i18n="button.save"
                    ></button>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div class="modal" id="qrModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 data-i18n="modal.qrTitle">üì± QR Code</h2>
                </div>
                <div style="text-align: center; padding: 20px">
                    <img
                        id="qrImage"
                        src=""
                        alt="QR Code"
                        style="max-width: 100%; border-radius: 8px"
                    />
                </div>
                <div class="modal-actions">
                    <button
                        class="btn-secondary"
                        onclick="closeQRModal()"
                        data-i18n="button.close"
                    ></button>
                    <button
                        class="btn-primary"
                        onclick="downloadQR()"
                        data-i18n="button.download"
                    ></button>
                </div>
            </div>
        </div>

        <script>
            let allUrls = [];
            let filteredUrls = [];
            let currentEditCode = null;
            let currentQRData = null;

            // Check authentication
            async function checkAuth() {
                try {
                    // Wait for navbar to be ready
                    while (!window.navbar) {
                        await new Promise((resolve) => setTimeout(resolve, 50));
                    }

                    // Use navbar component's checkAuth
                    const user = await window.navbar.checkAuth();

                    if (user) {
                        // User is authenticated
                        document
                            .getElementById("loginContainer")
                            .classList.add("hidden");
                        document
                            .getElementById("mainPanel")
                            .classList.remove("hidden");
                        loadUrls();
                    } else {
                        // User is not authenticated
                        document
                            .getElementById("loginContainer")
                            .classList.remove("hidden");
                        document
                            .getElementById("mainPanel")
                            .classList.add("hidden");
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    document
                        .getElementById("loginContainer")
                        .classList.remove("hidden");
                    document
                        .getElementById("mainPanel")
                        .classList.add("hidden");
                }
            }

            // Load user's URLs from API
            async function loadUrls() {
                try {
                    const res = await fetch("/api/my-urls");
                    console.log("Response status:", res.status);
                    if (res.ok) {
                        allUrls = await res.json();
                        console.log("Loaded URLs:", allUrls);
                        console.log("Number of URLs:", allUrls.length);
                        filteredUrls = allUrls;
                        updateStats();
                        renderTable();
                    } else {
                        const errorText = await res.text();
                        console.error("Error response:", errorText);
                        document.getElementById("tableContainer").innerHTML =
                            '<div class="empty">' +
                            window.i18n.t("message.loadError") +
                            "</div>";
                    }
                } catch (e) {
                    console.error("Failed to load URLs:", e);
                    document.getElementById("tableContainer").innerHTML =
                        '<div class="empty">' +
                        window.i18n.t("message.error") +
                        "</div>";
                }
            }

            // Update statistics
            function updateStats() {
                const total = allUrls.length;
                const today = allUrls.filter((url) => {
                    const created = new Date(url.created_at);
                    const now = new Date();
                    return (
                        created.getDate() === now.getDate() &&
                        created.getMonth() === now.getMonth() &&
                        created.getFullYear() === now.getFullYear()
                    );
                }).length;

                // Calculate total clicks
                const totalClicks = allUrls.reduce(
                    (sum, url) => sum + (url.clicks || 0),
                    0,
                );

                // Calculate average clicks
                const avgClicks =
                    total > 0 ? Math.round(totalClicks / total) : 0;

                // Find top URL
                const topUrl =
                    allUrls.length > 0
                        ? allUrls.reduce((max, url) =>
                              (url.clicks || 0) > (max.clicks || 0) ? url : max,
                          )
                        : null;

                // Count expiring soon (within 7 days)
                const now = new Date();
                const expiringSoon = allUrls.filter((url) => {
                    if (!url.expires_at) return false;
                    const expiryDate = new Date(url.expires_at);
                    const diffDays = Math.ceil((expiryDate - now) / 86400000);
                    return diffDays > 0 && diffDays <= 7;
                }).length;

                document.getElementById("totalUrls").textContent = total;
                document.getElementById("todayUrls").textContent = today;
                document.getElementById("totalClicks").textContent =
                    totalClicks.toLocaleString();
                document.getElementById("avgClicks").textContent = avgClicks;
                document.getElementById("topUrl").textContent = topUrl
                    ? topUrl.code
                    : "-";
                document.getElementById("expiringSoon").textContent =
                    expiringSoon;
            }

            // Render table
            function renderTable() {
                const container = document.getElementById("tableContainer");

                if (filteredUrls.length === 0) {
                    container.innerHTML =
                        '<div class="empty">' +
                        window.i18n.t("message.noUrls") +
                        '<br><br><a href="/" style="color: #007bff;">Create your first URL</a></div>';
                    return;
                }

                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Short Link</th>
                                <th data-i18n="label.targetUrl"></th>
                                <th data-i18n="label.memo"></th>
                                <th data-i18n="label.status"></th>
                                <th data-i18n="label.createdAt"></th>
                                <th data-i18n="label.manage"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUrls
                                .map(
                                    (url) => `
                                <tr>
                                    <td class="code-cell">
                                        <a href="${window.location.origin}/${url.code}" target="_blank"
                                           style="color: #007bff; text-decoration: none; font-weight: 600; font-family: 'Courier New', monospace; font-size: 14px;"
                                           onmouseover="this.style.textDecoration='underline'"
                                           onmouseout="this.style.textDecoration='none'"
                                           title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${window.location.origin}/${url.code}">
                                            üîó ${url.code}
                                        </a>
                                    </td>
                                    <td class="url-cell">
                                        <a href="${url.target}" target="_blank" title="${url.target}">
                                            ${url.target}
                                        </a>
                                    </td>
                                    <td class="date-cell">${url.memo || "-"}</td>
                                    <td class="date-cell" style="text-align: center; font-weight: 600; color: #007bff;">
                                        ${url.clicks || 0}
                                    </td>
                                    <td class="date-cell" style="text-align: center;">
                                        ${getExpiryStatus(url)}
                                    </td>
                                    <td class="date-cell">${formatDate(url.created_at)}</td>
                                    <td>
                                        <div class="actions">
                                            <button class="btn btn-copy" onclick="copyUrl('${window.location.origin}/${url.code}')">
                                                üìã
                                            </button>
                                            <button class="btn btn-copy" onclick="showQRCode('${url.code}')" style="background: #17a2b8;">
                                                üì± QR
                                            </button>
                                            <button class="btn btn-edit" onclick="openEditModal('${url.code}')">
                                                ‚úèÔ∏è <span data-i18n="button.edit"></span>
                                            </button>
                                            <button class="btn btn-delete" onclick="deleteUrl('${url.code}')">
                                                üóëÔ∏è <span data-i18n="button.delete"></span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;

                container.innerHTML = table;
            }

            // Get expiry status
            function getExpiryStatus(url) {
                if (!url.expires_at) {
                    return (
                        '<span style="color: #28a745;">' +
                        window.i18n.t("status.active") +
                        "</span>"
                    );
                }

                const now = new Date();
                const expiryDate = new Date(url.expires_at);
                const diffMs = expiryDate - now;
                const diffDays = Math.ceil(diffMs / 86400000);

                if (diffMs <= 0) {
                    return (
                        '<span style="color: #dc3545; font-weight: 600;">' +
                        window.i18n.t("status.expired") +
                        "</span>"
                    );
                } else if (diffDays <= 1) {
                    return (
                        '<span style="color: #ff6b6b;">' +
                        window.i18n.t("status.lessThanOneDay") +
                        "</span>"
                    );
                } else if (diffDays <= 7) {
                    return (
                        `<span style="color: #ffa500;">` +
                        window.i18n.t("status.daysRemaining", { n: diffDays }) +
                        `</span>`
                    );
                } else {
                    return (
                        `<span style="color: #666;">` +
                        window.i18n.t("status.daysRemainingNeutral", {
                            n: diffDays,
                        }) +
                        `</span>`
                    );
                }
            }

            // Format date
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return window.i18n.t("time.justNow");
                if (diffMins < 60)
                    return window.i18n.t("time.minutesAgo", { n: diffMins });
                if (diffHours < 24)
                    return window.i18n.t("time.hoursAgo", { n: diffHours });
                if (diffDays < 7)
                    return window.i18n.t("time.daysAgo", { n: diffDays });

                return date.toLocaleDateString("th-TH", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            // Copy URL to clipboard
            function copyUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    alert(window.i18n.t("message.linkCopied"));
                });
            }

            // Open edit modal
            function openEditModal(code) {
                const url = allUrls.find((u) => u.code === code);
                if (!url) return;

                currentEditCode = code;
                document.getElementById("editCode").value = url.code;
                document.getElementById("editTarget").value = url.target;
                document.getElementById("editMemo").value = url.memo || "";
                document.getElementById("editError").textContent = "";
                document.getElementById("editModal").classList.add("show");
            }

            // Close edit modal
            function closeEditModal() {
                document.getElementById("editModal").classList.remove("show");
                currentEditCode = null;
            }

            // Save edit
            async function saveEdit() {
                const newCode = document
                    .getElementById("editCode")
                    .value.trim();
                const target = document
                    .getElementById("editTarget")
                    .value.trim();
                const memo = document.getElementById("editMemo").value.trim();
                const errorDiv = document.getElementById("editError");

                if (!newCode || !target) {
                    errorDiv.textContent = window.i18n.t("validation.required");
                    return;
                }

                try {
                    const res = await fetch(`/api/urls/${currentEditCode}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ newCode, target, memo }),
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert(
                            window.i18n.t("message.actionSuccess", {
                                action: "‚úèÔ∏è",
                            }),
                        );
                        closeEditModal();
                        loadUrls();
                    } else {
                        errorDiv.textContent =
                            data.error || window.i18n.t("validation.error");
                    }
                } catch (e) {
                    console.error("Edit failed:", e);
                    errorDiv.textContent = window.i18n.t(
                        "validation.connectionError",
                    );
                }
            }

            // Show QR Code
            async function showQRCode(code) {
                try {
                    const res = await fetch(`/api/qr/${code}`);
                    const data = await res.json();

                    if (res.ok) {
                        currentQRData = data.qrCode;
                        document.getElementById("qrImage").src = data.qrCode;
                        document.getElementById("qrUrl").textContent =
                            `${window.location.origin}/${code}`;
                        document
                            .getElementById("qrModal")
                            .classList.add("show");
                    } else {
                        alert("‚ùå " + data.error);
                    }
                } catch (e) {
                    console.error("QR generation failed:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                }
            }

            // Close QR Modal
            function closeQRModal() {
                document.getElementById("qrModal").classList.remove("show");
                currentQRData = null;
            }

            // Download QR Code
            function downloadQR() {
                if (!currentQRData) return;

                const link = document.createElement("a");
                link.href = currentQRData;
                link.download = "qrcode.png";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Change button text temporarily to show success
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = window.i18n.t("message.downloadSuccess");
                btn.style.background = "#28a745";
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = "";
                }, 2000);
            }

            // Refresh data
            function refreshData() {
                loadUrls();
            }

            // Export to CSV
            function exportCSV() {
                if (allUrls.length === 0) {
                    return; // Silently do nothing
                }

                const headers = [
                    "Code",
                    "Target URL",
                    "Memo",
                    "Clicks",
                    "Expires At",
                    "Created At",
                ];
                const rows = allUrls.map((url) => [
                    url.code,
                    url.target,
                    url.memo || "",
                    url.clicks || 0,
                    url.expires_at || "",
                    url.created_at,
                ]);

                let csv = headers.join(",") + "\n";
                rows.forEach((row) => {
                    csv += row.map((field) => `"${field}"`).join(",") + "\n";
                });

                const blob = new Blob([csv], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `my-urls-${new Date().toISOString().split("T")[0]}.csv`;
                link.click();
            }

            // Export to JSON
            function exportJSON() {
                if (allUrls.length === 0) {
                    return; // Silently do nothing
                }

                const data = JSON.stringify(allUrls, null, 2);
                const blob = new Blob([data], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `my-urls-${new Date().toISOString().split("T")[0]}.json`;
                link.click();
            }

            // Delete URL
            async function deleteUrl(code) {
                if (
                    !confirm(
                        window.i18n.t("message.confirmAction", {
                            action: "üóëÔ∏è",
                        }),
                    )
                ) {
                    return;
                }

                try {
                    const res = await fetch(`/api/urls/${code}`, {
                        method: "DELETE",
                    });

                    if (res.ok) {
                        alert(
                            window.i18n.t("message.actionSuccess", {
                                action: "üóëÔ∏è",
                            }),
                        );
                        loadUrls();
                    } else {
                        const data = await res.json();
                        alert(
                            "‚ùå " +
                                (data.error ||
                                    window.i18n.t("message.actionError")),
                        );
                    }
                } catch (e) {
                    console.error("Delete failed:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
                }
            }

            // Search functionality
            document
                .getElementById("searchInput")
                ?.addEventListener("input", (e) => {
                    const query = e.target.value.toLowerCase();
                    filteredUrls = allUrls.filter((url) => {
                        return (
                            url.code.toLowerCase().includes(query) ||
                            url.target.toLowerCase().includes(query)
                        );
                    });
                    renderTable();
                });

            // Close modal on outside click
            document
                .getElementById("editModal")
                .addEventListener("click", (e) => {
                    if (e.target.id === "editModal") {
                        closeEditModal();
                    }
                });

            // Initialize
            checkAuth();
        </script>
        <script src="navbar.js"></script>
        <script src="i18n.js"></script>
    </body>
</html>
