<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title>TinyURL Generator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/css/navbar.css" />
        <link rel="stylesheet" href="/css/create.css" />
    </head>
    <body>
        <!-- Main App -->
        <div class="card" id="mainApp">
            <h2 data-i18n="home.title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô</h2>
            <input
                type="text"
                id="urlInput"
                data-i18n-placeholder="placeholder.enterUrl"
                placeholder=""
                style="margin-bottom: 10px"
            />
            <input
                type="text"
                id="customCodeInput"
                data-i18n-placeholder="placeholder.customCode"
                placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÄ‡∏ä‡πà‡∏ô: meeting, docs2024"
                style="margin-top: 10px"
            />
            <div
                style="
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                    margin-left: 5px;
                "
                data-i18n="home.customCodeHint"
            >
                üí° ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á =
                ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 3-20 ‡∏ï‡∏±‡∏ß
            </div>
            <select
                id="expirySelect"
                style="
                    margin-top: 10px;
                    padding: 12px;
                    font-size: 14px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    width: 100%;
                "
            >
                <option value="" data-i18n="expiry.permanent"></option>
                <option value="1" data-i18n="expiry.1day"></option>
                <option value="7" data-i18n="expiry.7days"></option>
                <option value="30" data-i18n="expiry.30days"></option>
                <option value="90" data-i18n="expiry.90days"></option>
                <option value="365" data-i18n="expiry.1year"></option>
            </select>
            <input
                type="text"
                id="memoInput"
                data-i18n-placeholder="placeholder.memo"
                placeholder=""
                style="margin-top: 10px"
            />
            <button id="shortenBtn" data-i18n="home.createLink"></button>
            <div class="result" id="result"></div>
            <div class="list" id="list"></div>
        </div>

        <script>
            const input = document.getElementById("urlInput");
            const customCodeInput = document.getElementById("customCodeInput");
            const btn = document.getElementById("shortenBtn");
            const result = document.getElementById("result");
            const list = document.getElementById("list");
            const mainApp = document.getElementById("mainApp");

            const history = [];

            // Check authentication on page load
            async function checkAuth() {
                try {
                    // Wait for navbar to be ready
                    while (!window.navbar) {
                        await new Promise((resolve) => setTimeout(resolve, 50));
                    }

                    // Use navbar component's checkAuth
                    const user = await window.navbar.checkAuth();

                    if (!user) {
                        // User is not authenticated, redirect to login
                        window.location.href = "/";
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    window.location.href = "/";
                }
            }

            // Check auth on load
            checkAuth();

            btn.addEventListener("click", async () => {
                const url = input.value.trim();
                const memo = document.getElementById("memoInput").value.trim();
                const customCode = customCodeInput.value.trim();
                const expiresInDays =
                    document.getElementById("expirySelect").value;

                if (!url) {
                    result.innerHTML = window.i18n.t("message.enterUrl");
                    return;
                }

                result.innerHTML = window.i18n.t("message.creatingLink");
                try {
                    const requestBody = { url, memo };
                    if (customCode) {
                        requestBody.customCode = customCode;
                    }
                    if (expiresInDays) {
                        requestBody.expiresInDays = parseInt(expiresInDays);
                    }

                    const res = await fetch("/api/shorten", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody),
                    });
                    const data = await res.json();
                    if (data.short) {
                        result.innerHTML = `
            ${window.i18n.t("message.linkReady")}:<br>
            <div class="shortlink">
              <a href="${data.short}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 600; font-size: 16px;">${data.short}</a>
            </div>
            <div style="margin-top: 12px; font-size: 13px; color: #666;">
              ${window.i18n.t("message.clickTest")}
              <button onclick="navigator.clipboard.writeText('${data.short}')" style="margin-left: 5px;">üìã ${window.i18n.t("button.copy")}</button>
            </div>
          `;
                        history.unshift(data);
                        renderList();
                        // Clear inputs after success
                        input.value = "";
                        customCodeInput.value = "";
                        document.getElementById("expirySelect").value = "";
                        document.getElementById("memoInput").value = "";
                    } else {
                        result.innerHTML =
                            "‚ùå " + window.i18n.t("message.error");
                    }
                } catch (e) {
                    result.innerHTML =
                        "‚ùå " + window.i18n.t("message.loadError");
                    // Check if it's an auth error
                    if (e.message && e.message.includes("401")) {
                        result.innerHTML =
                            "‚ùå " + window.i18n.t("login.pleaseLogin");
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                }
            });

            function renderList() {
                list.innerHTML = history
                    .map(
                        (h) =>
                            `<div class="list-item">üîó <a href="${h.short}" target="_blank">${h.short}</a></div>`,
                    )
                    .join("");
            }
        </script>
        <script src="navbar.js"></script>
        <script src="i18n.js"></script>
    </body>
</html>
