<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title>TinyURL Generator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/css/navbar.css" />
        <link rel="stylesheet" href="/css/create.css" />
    </head>
    <body>
        <!-- Guest Benefits Banner -->
        <div class="benefits-banner hidden" id="benefitsBanner">
            <div class="benefits-content">
                <h3 data-i18n="guest.benefitsTitle">
                    üéÅ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©!
                </h3>
                <ul class="benefits-list">
                    <li data-i18n="guest.benefit1">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</li>
                    <li data-i18n="guest.benefit2">‚ú® ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</li>
                    <li data-i18n="guest.benefit3">
                        üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° memo ‡πÑ‡∏î‡πâ
                    </li>
                    <li data-i18n="guest.benefit4">‚è∞ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</li>
                    <li data-i18n="guest.benefit5">üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å</li>
                </ul>
                <button
                    class="signup-btn"
                    onclick="window.location.href='/auth/google'"
                    data-i18n="guest.signup"
                >
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ü‡∏£‡∏µ
                </button>
            </div>
        </div>

        <!-- Guest Usage Counter -->
        <div class="guest-counter hidden" id="guestCounter">
            <span data-i18n="guest.remaining">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å</span>
            <strong id="remainingCount">3</strong>
            <span data-i18n="guest.timesPerDay">‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô</span>
        </div>

        <!-- Main Form -->
        <div class="card" id="mainApp">
            <h2 data-i18n="home.title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô</h2>
            <input
                type="text"
                id="urlInput"
                data-i18n-placeholder="placeholder.enterUrl"
                style="margin-bottom: 10px"
            />
            <input
                type="text"
                id="customCodeInput"
                data-i18n-placeholder="placeholder.customCode"
                style="margin-top: 10px"
            />
            <div
                style="
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                    margin-left: 5px;
                "
                data-i18n="home.customCodeHint"
            >
                üí° ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á =
                ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 3-20 ‡∏ï‡∏±‡∏ß
            </div>
            <select
                id="expirySelect"
                style="
                    margin-top: 10px;
                    padding: 12px;
                    font-size: 14px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    width: 100%;
                "
            >
                <option value="" data-i18n="expiry.permanent"></option>
                <option value="1" data-i18n="expiry.1day"></option>
                <option value="7" data-i18n="expiry.7days"></option>
                <option value="30" data-i18n="expiry.30days"></option>
                <option value="90" data-i18n="expiry.90days"></option>
                <option value="365" data-i18n="expiry.1year"></option>
            </select>
            <input
                type="text"
                id="memoInput"
                data-i18n-placeholder="placeholder.memo"
                style="margin-top: 10px"
            />
            <button id="shortenBtn" data-i18n="home.createLink"></button>
            <div class="result" id="result"></div>
        </div>

        <script src="/i18n.js"></script>
        <script src="/navbar.js"></script>
        <script>
            let isGuest = true;
            let guestRemaining = 3;

            // Initialize navbar with callback
            const navbar = new Navbar({
                style: "navbar",
                onAuthChange: (user) => {
                    isGuest = !user;

                    if (user) {
                        // Logged-in user: hide guest elements, show all fields
                        document
                            .getElementById("benefitsBanner")
                            .classList.add("hidden");
                        document
                            .getElementById("guestCounter")
                            .classList.add("hidden");
                        document.getElementById(
                            "customCodeInput",
                        ).style.display = "block";
                        document.querySelector(
                            '[data-i18n="home.customCodeHint"]',
                        ).style.display = "block";
                        document.getElementById("expirySelect").style.display =
                            "block";
                        document.getElementById("memoInput").style.display =
                            "block";
                    } else {
                        // Guest: show guest elements, hide restricted fields
                        document
                            .getElementById("benefitsBanner")
                            .classList.remove("hidden");
                        document
                            .getElementById("guestCounter")
                            .classList.remove("hidden");
                        document.getElementById(
                            "customCodeInput",
                        ).style.display = "none";
                        document.querySelector(
                            '[data-i18n="home.customCodeHint"]',
                        ).style.display = "none";
                        document.getElementById("expirySelect").style.display =
                            "none";
                        document.getElementById("memoInput").style.display =
                            "none";
                    }

                    // Update translations after auth change
                    if (window.i18n) {
                        window.i18n.updatePage();
                    }
                },
            });

            // Check auth on load
            navbar.checkAuth();

            // Form submission
            document
                .getElementById("shortenBtn")
                .addEventListener("click", async () => {
                    const url = document
                        .getElementById("urlInput")
                        .value.trim();
                    const memo = document
                        .getElementById("memoInput")
                        .value.trim();
                    const customCode = document
                        .getElementById("customCodeInput")
                        .value.trim();
                    const expiresInDays =
                        document.getElementById("expirySelect").value;
                    const result = document.getElementById("result");

                    if (!url) {
                        result.innerHTML = window.i18n.t("message.enterUrl");
                        return;
                    }

                    result.innerHTML = window.i18n
                        ? window.i18n.t("message.creatingLink")
                        : "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå...";

                    try {
                        const requestBody = { url, memo };
                        if (customCode) requestBody.customCode = customCode;
                        if (expiresInDays)
                            requestBody.expiresInDays = parseInt(expiresInDays);

                        const res = await fetch("/api/shorten", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(requestBody),
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            if (res.status === 429) {
                                result.innerHTML = `
                            ‚ùå ${data.message || window.i18n.t("guest.limitExceeded")}<br>
                            <button onclick="window.location.href='/auth/google'" style="margin-top: 10px; padding: 8px 16px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ${window.i18n.t("guest.signup")}
                            </button>
                        `;
                            } else if (data.requiresLogin) {
                                result.innerHTML = `‚ùå ${data.error}<br><button onclick="window.location.href='/auth/google'" style="margin-top: 10px;">${window.i18n.t("button.loginGoogle")}</button>`;
                            } else {
                                result.innerHTML =
                                    "‚ùå " +
                                    (data.error ||
                                        window.i18n.t("message.error"));
                            }
                            return;
                        }

                        // Update guest counter if applicable
                        if (data.guestInfo) {
                            guestRemaining = data.guestInfo.remaining;
                            document.getElementById(
                                "remainingCount",
                            ).textContent = guestRemaining;
                            if (guestRemaining === 0) {
                                document.getElementById(
                                    "guestCounter",
                                ).style.color = "#dc3545";
                                document.getElementById(
                                    "guestCounter",
                                ).style.fontWeight = "bold";
                            }
                        }

                        // Redirect to showlink page
                        window.location.href = `/showlink?code=${data.code}`;
                    } catch (e) {
                        result.innerHTML =
                            "‚ùå " + window.i18n.t("message.loadError");
                    }
                });
        </script>
    </body>
</html>
