<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title>TinyURL Generator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/css/navbar.css" />
        <link rel="stylesheet" href="/css/create.css" />
    </head>
    <body>
        <!-- Guest Benefits Banner (hidden for logged-in users) -->
        <div class="benefits-banner hidden" id="benefitsBanner">
            <div class="benefits-content">
                <h3 data-i18n="guest.benefitsTitle">
                    üéÅ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©!
                </h3>
                <ul class="benefits-list">
                    <li data-i18n="guest.benefit1">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</li>
                    <li data-i18n="guest.benefit2">‚ú® ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</li>
                    <li data-i18n="guest.benefit3">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ</li>
                    <li data-i18n="guest.benefit4">üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å</li>
                </ul>
                <button
                    class="signup-btn"
                    onclick="window.location.href='/auth/google'"
                    data-i18n="guest.signup"
                >
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ü‡∏£‡∏µ
                </button>
            </div>
        </div>

        <!-- Guest Usage Counter -->
        <div class="guest-counter hidden" id="guestCounter">
            <span data-i18n="guest.remaining">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å</span>
            <strong id="remainingCount">3</strong>
            <span data-i18n="guest.timesPerDay">‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô</span>
        </div>

        <!-- Main App -->
        <div class="card" id="mainApp">
            <h2 data-i18n="home.title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô</h2>
            <input
                type="text"
                id="urlInput"
                data-i18n-placeholder="placeholder.enterUrl"
                placeholder=""
                style="margin-bottom: 10px"
            />
            <input
                type="text"
                id="customCodeInput"
                data-i18n-placeholder="placeholder.customCode"
                placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÄ‡∏ä‡πà‡∏ô: meeting, docs2024"
                style="margin-top: 10px"
            />
            <div
                style="
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                    margin-left: 5px;
                "
                data-i18n="home.customCodeHint"
            >
                üí° ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á =
                ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 3-20 ‡∏ï‡∏±‡∏ß
            </div>
            <select
                id="expirySelect"
                style="
                    margin-top: 10px;
                    padding: 12px;
                    font-size: 14px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    width: 100%;
                "
            >
                <option value="" data-i18n="expiry.permanent"></option>
                <option value="1" data-i18n="expiry.1day"></option>
                <option value="7" data-i18n="expiry.7days"></option>
                <option value="30" data-i18n="expiry.30days"></option>
                <option value="90" data-i18n="expiry.90days"></option>
                <option value="365" data-i18n="expiry.1year"></option>
            </select>
            <input
                type="text"
                id="memoInput"
                data-i18n-placeholder="placeholder.memo"
                placeholder=""
                style="margin-top: 10px"
            />
            <button id="shortenBtn" data-i18n="home.createLink"></button>
            <div class="result" id="result"></div>
            <div class="list" id="list"></div>
        </div>

        <script>
            const input = document.getElementById("urlInput");
            const customCodeInput = document.getElementById("customCodeInput");
            const btn = document.getElementById("shortenBtn");
            const result = document.getElementById("result");
            const list = document.getElementById("list");
            const mainApp = document.getElementById("mainApp");

            const history = [];

            let isGuest = true;
            let guestRemaining = 3;

            // Check authentication on page load
            async function checkAuth() {
                try {
                    // Wait for navbar to be ready
                    while (!window.navbar) {
                        await new Promise((resolve) => setTimeout(resolve, 50));
                    }

                    // Use navbar component's checkAuth
                    const user = await window.navbar.checkAuth();

                    if (user) {
                        // User is authenticated - hide guest elements
                        isGuest = false;
                        document
                            .getElementById("benefitsBanner")
                            .classList.add("hidden");
                        document
                            .getElementById("guestCounter")
                            .classList.add("hidden");
                    } else {
                        // User is guest - show guest UI
                        isGuest = true;
                        document
                            .getElementById("benefitsBanner")
                            .classList.remove("hidden");
                        document
                            .getElementById("guestCounter")
                            .classList.remove("hidden");

                        // Hide custom code field for guests
                        customCodeInput.style.display = "none";
                        document.querySelector(
                            '[data-i18n="home.customCodeHint"]',
                        ).style.display = "none";
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    // Allow guest access on error
                    isGuest = true;
                    document
                        .getElementById("benefitsBanner")
                        .classList.remove("hidden");
                    document
                        .getElementById("guestCounter")
                        .classList.remove("hidden");
                    customCodeInput.style.display = "none";
                    document.querySelector(
                        '[data-i18n="home.customCodeHint"]',
                    ).style.display = "none";
                }
            }

            // Check auth on load
            checkAuth();

            btn.addEventListener("click", async () => {
                const url = input.value.trim();
                const memo = document.getElementById("memoInput").value.trim();
                const customCode = customCodeInput.value.trim();
                const expiresInDays =
                    document.getElementById("expirySelect").value;

                if (!url) {
                    result.innerHTML = window.i18n.t("message.enterUrl");
                    return;
                }

                result.innerHTML = window.i18n.t("message.creatingLink");
                try {
                    const requestBody = { url, memo };
                    if (customCode) {
                        requestBody.customCode = customCode;
                    }
                    if (expiresInDays) {
                        requestBody.expiresInDays = parseInt(expiresInDays);
                    }

                    const res = await fetch("/api/shorten", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody),
                    });
                    const data = await res.json();

                    if (!res.ok) {
                        // Handle errors
                        if (res.status === 429) {
                            // Rate limit exceeded
                            result.innerHTML = `
                                ‚ùå ${data.message || window.i18n.t("guest.limitExceeded")}<br>
                                <button onclick="window.location.href='/auth/google'" style="margin-top: 10px; padding: 8px 16px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ${window.i18n.t("guest.signup")}
                                </button>
                            `;
                        } else if (data.requiresLogin) {
                            result.innerHTML = `
                                ‚ùå ${data.error}<br>
                                <button onclick="window.location.href='/auth/google'" style="margin-top: 10px;">
                                    ${window.i18n.t("button.loginGoogle")}
                                </button>
                            `;
                        } else {
                            result.innerHTML =
                                "‚ùå " +
                                (data.error || window.i18n.t("message.error"));
                        }
                        return;
                    }

                    if (data.short) {
                        result.innerHTML = `
            ${window.i18n.t("message.linkReady")}:<br>
            <div class="shortlink">
              <a href="${data.short}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 600; font-size: 16px;">${data.short}</a>
            </div>
            <div style="margin-top: 12px; font-size: 13px; color: #666;">
              ${window.i18n.t("message.clickTest")}
              <button onclick="navigator.clipboard.writeText('${data.short}')" style="margin-left: 5px;">üìã ${window.i18n.t("button.copy")}</button>
            </div>
            ${
                data.qrCode
                    ? `
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0; font-size: 14px;">QR Code</h4>
              <img src="${data.qrCode}" alt="QR Code" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
              <div style="margin-top: 10px;">
                <button onclick="downloadQRCode('${data.qrCode}', '${data.code}')" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                  üíæ ${window.i18n.t("button.download")} QR Code
                </button>
              </div>
            </div>
            `
                    : ""
            }
          `;

                        // Update guest counter if applicable
                        if (data.guestInfo) {
                            guestRemaining = data.guestInfo.remaining;
                            document.getElementById(
                                "remainingCount",
                            ).textContent = guestRemaining;

                            if (guestRemaining === 0) {
                                document.getElementById(
                                    "guestCounter",
                                ).style.color = "#dc3545";
                                document.getElementById(
                                    "guestCounter",
                                ).style.fontWeight = "bold";
                            }
                        }

                        history.unshift(data);
                        renderList();
                        // Clear inputs after success
                        input.value = "";
                        if (!isGuest) {
                            customCodeInput.value = "";
                        }
                        document.getElementById("expirySelect").value = "";
                        document.getElementById("memoInput").value = "";
                    } else {
                        result.innerHTML =
                            "‚ùå " + window.i18n.t("message.error");
                    }
                } catch (e) {
                    result.innerHTML =
                        "‚ùå " + window.i18n.t("message.loadError");
                    // Check if it's an auth error
                    if (e.message && e.message.includes("401")) {
                        result.innerHTML =
                            "‚ùå " + window.i18n.t("login.pleaseLogin");
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                }
            });

            function renderList() {
                list.innerHTML = history
                    .map(
                        (h) =>
                            `<div class="list-item">üîó <a href="${h.short}" target="_blank">${h.short}</a></div>`,
                    )
                    .join("");
            }

            // Download QR Code function
            function downloadQRCode(dataUrl, filename) {
                const link = document.createElement("a");
                link.href = dataUrl;
                link.download = `qrcode-${filename}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Make it globally accessible
            window.downloadQRCode = downloadQRCode;
        </script>
        <script src="navbar.js"></script>
        <script src="i18n.js"></script>
    </body>
</html>
