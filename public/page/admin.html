<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title data-i18n="nav.admin">Admin - TinyURL</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/css/navbar.css" />
        <link rel="stylesheet" href="/css/admin.css" />
    </head>
    <body>
        <!-- Login Screen -->
        <div class="login-container hidden" id="loginContainer">
            <div
                style="
                    display: flex;
                    gap: 5px;
                    justify-content: center;
                    margin-bottom: 20px;
                "
            >
                <button
                    onclick="window.i18n.setLang('th')"
                    id="langBtnTh1"
                    class="lang-btn"
                    style="padding: 5px 10px; font-size: 13px; font-weight: 600"
                >
                    TH
                </button>
                <button
                    onclick="window.i18n.setLang('en')"
                    id="langBtnEn1"
                    class="lang-btn"
                    style="padding: 5px 10px; font-size: 13px; font-weight: 600"
                >
                    EN
                </button>
            </div>
            <h2 data-i18n="login.welcome"></h2>
            <p style="margin: 20px 0" data-i18n="admin.loginDescription"></p>
            <button
                class="login-btn"
                onclick="window.location.href='/auth/google'"
            >
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path
                        fill="#4285F4"
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                    />
                    <path
                        fill="#34A853"
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
                    />
                    <path
                        fill="#FBBC05"
                        d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
                    />
                    <path
                        fill="#EA4335"
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                    />
                </svg>
                <span data-i18n="button.loginGoogle"></span>
            </button>
        </div>

        <!-- Main Admin Panel -->
        <div class="container hidden" id="adminPanel">
            <div class="header">
                <h1 data-i18n="admin.title">üìä Admin Panel - TinyURL</h1>
                <div class="nav">
                    <a href="/" data-i18n="nav.home"></a>
                    <a href="/my-urls" data-i18n="nav.myUrls"></a>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button
                    class="tab-btn active"
                    onclick="switchTab('urls')"
                    data-i18n="admin.urlManagement"
                ></button>
                <button
                    class="tab-btn"
                    onclick="switchTab('users')"
                    data-i18n="admin.userManagement"
                ></button>
            </div>

            <!-- URLs Tab -->
            <div class="tab-content active" id="urlsTab">
                <div class="stats">
                    <div class="stat-card">
                        <h3 data-i18n="admin.totalUrls"></h3>
                        <div class="number" id="totalUrls">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-i18n="stats.createdToday"></h3>
                        <div class="number" id="todayUrls">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-i18n="admin.totalUsers"></h3>
                        <div class="number" id="totalUsers">0</div>
                    </div>
                </div>

                <div class="content">
                    <div class="search-box">
                        <input
                            type="text"
                            id="searchUrlInput"
                            data-i18n-placeholder="admin.searchUrl"
                            placeholder=""
                        />
                    </div>
                    <div id="urlTableContainer">
                        <div class="loading" data-i18n="message.loading"></div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-content" id="usersTab">
                <div class="stats">
                    <div class="stat-card">
                        <h3 data-i18n="admin.totalUsers"></h3>
                        <div class="number" id="totalUsersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-i18n="admin.activeUsers"></h3>
                        <div class="number" id="activeUsersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-i18n="admin.admins"></h3>
                        <div class="number" id="adminCount">0</div>
                    </div>
                </div>

                <div class="content">
                    <div class="search-box">
                        <input
                            type="text"
                            id="searchUserInput"
                            data-i18n-placeholder="admin.searchUser"
                            placeholder=""
                        />
                    </div>
                    <div id="userTableContainer">
                        <div class="loading" data-i18n="message.loading"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Role Modal -->
        <div class="modal" id="roleModal">
            <div class="modal-content">
                <h3 data-i18n="admin.changeRole"></h3>
                <div class="form-group">
                    <label data-i18n="admin.user"></label>
                    <div
                        id="modalUserName"
                        style="font-weight: 500; margin-bottom: 10px"
                    ></div>
                </div>
                <div class="form-group">
                    <label data-i18n="admin.newRole"></label>
                    <select id="newRoleSelect">
                        <option value="USER" data-i18n="role.user"></option>
                        <option value="ADMIN" data-i18n="role.admin"></option>
                        <option
                            value="SUPER_ADMIN"
                            data-i18n="role.superAdmin"
                        ></option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button
                        class="btn-cancel"
                        onclick="closeRoleModal()"
                        data-i18n="button.cancel"
                    ></button>
                    <button
                        class="btn-confirm"
                        onclick="confirmRoleChange()"
                        data-i18n="button.confirm"
                    ></button>
                </div>
            </div>
        </div>

        <script>
            let allUrls = [];
            let filteredUrls = [];
            let allUsers = [];
            let filteredUsers = [];
            let currentUser = null;
            let selectedUserId = null;

            // Check authentication
            async function checkAuth() {
                try {
                    // Wait for navbar to be ready
                    while (!window.navbar) {
                        await new Promise((resolve) => setTimeout(resolve, 50));
                    }

                    // Use navbar component's checkAuth
                    currentUser = await window.navbar.checkAuth();

                    if (currentUser) {
                        // User is authenticated
                        document
                            .getElementById("loginContainer")
                            .classList.add("hidden");
                        document
                            .getElementById("adminPanel")
                            .classList.remove("hidden");
                        loadUrls();
                        loadUsers();
                    } else {
                        // User is not authenticated
                        document
                            .getElementById("loginContainer")
                            .classList.remove("hidden");
                        document
                            .getElementById("adminPanel")
                            .classList.add("hidden");
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    document
                        .getElementById("loginContainer")
                        .classList.remove("hidden");
                    document
                        .getElementById("adminPanel")
                        .classList.add("hidden");
                }
            }

            // Switch tabs
            function switchTab(tab) {
                const tabs = ["urls", "users"];
                tabs.forEach((t) => {
                    document
                        .getElementById(t + "Tab")
                        .classList.remove("active");
                });
                document.getElementById(tab + "Tab").classList.add("active");

                const btns = document.querySelectorAll(".tab-btn");
                btns.forEach((btn) => btn.classList.remove("active"));
                event.target.classList.add("active");
            }

            // ===== URLs Management =====
            async function loadUrls() {
                try {
                    const res = await fetch("/api/urls");
                    if (res.ok) {
                        allUrls = await res.json();
                        filteredUrls = allUrls;
                        updateUrlStats();
                        renderUrlTable();
                    } else {
                        document.getElementById("urlTableContainer").innerHTML =
                            `<div class="empty">${window.i18n.t("message.loadError")}</div>`;
                    }
                } catch (e) {
                    console.error("Failed to load URLs:", e);
                    document.getElementById("urlTableContainer").innerHTML =
                        `<div class="empty">${window.i18n.t("message.error")}</div>`;
                }
            }

            function updateUrlStats() {
                const total = allUrls.length;
                const today = allUrls.filter((url) => {
                    const created = new Date(url.created_at);
                    const now = new Date();
                    return (
                        created.getDate() === now.getDate() &&
                        created.getMonth() === now.getMonth() &&
                        created.getFullYear() === now.getFullYear()
                    );
                }).length;

                const uniqueUsers = new Set(
                    allUrls
                        .filter((url) => url.created_by)
                        .map((url) => url.created_by.id),
                ).size;

                document.getElementById("totalUrls").textContent = total;
                document.getElementById("todayUrls").textContent = today;
                document.getElementById("totalUsers").textContent = uniqueUsers;
            }

            function renderUrlTable() {
                const container = document.getElementById("urlTableContainer");
                if (filteredUrls.length === 0) {
                    container.innerHTML = `<div class="empty">${window.i18n.t("message.noUrls")}</div>`;
                    return;
                }

                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>${window.i18n.t("table.shortLink")}</th>
                                <th>${window.i18n.t("table.targetUrl")}</th>
                                <th>${window.i18n.t("table.memo")}</th>
                                <th>${window.i18n.t("table.clicks")}</th>
                                <th>${window.i18n.t("table.creator")}</th>
                                <th>${window.i18n.t("table.createdAt")}</th>
                                <th>${window.i18n.t("table.copy")}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUrls
                                .map(
                                    (url) => `
                                <tr>
                                    <td class="code-cell">
                                        <a href="${window.location.origin}/${url.code}" target="_blank"
                                           style="color: #007bff; text-decoration: none; font-weight: 600;">
                                            üîó ${url.code}
                                        </a>
                                    </td>
                                    <td class="url-cell">
                                        <a href="${url.target}" target="_blank" title="${url.target}">
                                            ${url.target}
                                        </a>
                                    </td>
                                    <td class="date-cell">${url.memo || "-"}</td>
                                    <td class="date-cell" style="text-align: center; font-weight: 600; color: #007bff;">
                                        ${url.clicks || 0}
                                    </td>
                                    <td class="user-cell">
                                        ${
                                            url.created_by
                                                ? `
                                            <div class="user-name">${url.created_by.name}</div>
                                            <div class="user-email">${url.created_by.email}</div>
                                        `
                                                : '<span style="color: #999">-</span>'
                                        }
                                    </td>
                                    <td class="date-cell">${formatDate(url.created_at)}</td>
                                    <td>
                                        <button class="copy-btn" onclick="copyUrl('${window.location.origin}/${url.code}')">
                                            üìã ${window.i18n.t("table.copy")}
                                        </button>
                                    </td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;
                container.innerHTML = table;
            }

            // ===== User Management =====
            async function loadUsers() {
                try {
                    const res = await fetch("/api/admin/users");
                    if (res.ok) {
                        allUsers = await res.json();
                        filteredUsers = allUsers;
                        updateUserStats();
                        renderUserTable();
                    } else {
                        document.getElementById(
                            "userTableContainer",
                        ).innerHTML =
                            `<div class="empty">${window.i18n.t("message.loadError")}</div>`;
                    }
                } catch (e) {
                    console.error("Failed to load users:", e);
                    document.getElementById("userTableContainer").innerHTML =
                        `<div class="empty">${window.i18n.t("message.error")}</div>`;
                }
            }

            function updateUserStats() {
                const total = allUsers.length;
                const active = allUsers.filter((u) => u.isActive).length;
                const admins = allUsers.filter(
                    (u) => u.role === "ADMIN" || u.role === "SUPER_ADMIN",
                ).length;

                document.getElementById("totalUsersCount").textContent = total;
                document.getElementById("activeUsersCount").textContent =
                    active;
                document.getElementById("adminCount").textContent = admins;
            }

            function renderUserTable() {
                const container = document.getElementById("userTableContainer");
                if (filteredUsers.length === 0) {
                    container.innerHTML = `<div class="empty">${window.i18n.t("message.noUsers")}</div>`;
                    return;
                }

                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>${window.i18n.t("table.name")}</th>
                                <th>${window.i18n.t("table.email")}</th>
                                <th>${window.i18n.t("table.role")}</th>
                                <th>${window.i18n.t("table.status")}</th>
                                <th>${window.i18n.t("table.lastLogin")}</th>
                                <th>${window.i18n.t("table.manage")}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUsers
                                .map(
                                    (user) => `
                                <tr>
                                    <td class="user-cell">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="${user.photo}" alt="" style="width: 32px; height: 32px; border-radius: 50%;">
                                            <div class="user-name">${user.name}</div>
                                        </div>
                                    </td>
                                    <td>${user.email}</td>
                                    <td>
                                        <span class="role-badge role-${user.role.toLowerCase().replace("_", "")}">
                                            ${user.role === "SUPER_ADMIN" ? window.i18n.t("role.superAdmin") : user.role === "ADMIN" ? window.i18n.t("role.admin") : window.i18n.t("role.user")}
                                        </span>
                                    </td>
                                    <td class="${user.isActive ? "status-active" : "status-inactive"}">
                                        ${user.isActive ? window.i18n.t("status.active") : window.i18n.t("status.inactive")}
                                    </td>
                                    <td class="date-cell">${user.lastLogin ? formatDate(user.lastLogin) : "-"}</td>
                                    <td>
                                        ${
                                            user.googleId !== currentUser.id
                                                ? `
                                            <button class="action-btn btn-role" onclick="openRoleModal('${user.googleId}', '${user.name}', '${user.role}')">
                                                ${window.i18n.t("button.changeRole")}
                                            </button>
                                            <button class="action-btn btn-toggle" onclick="toggleUserStatus('${user.googleId}', ${user.isActive})">
                                                ${user.isActive ? window.i18n.t("button.deactivate") : window.i18n.t("button.activate")}
                                            </button>
                                        `
                                                : '<span style="color: #999;">-</span>'
                                        }
                                    </td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;
                container.innerHTML = table;
            }

            function openRoleModal(userId, userName, currentRole) {
                selectedUserId = userId;
                document.getElementById("modalUserName").textContent = userName;
                document.getElementById("newRoleSelect").value = currentRole;
                document.getElementById("roleModal").classList.add("show");
            }

            function closeRoleModal() {
                document.getElementById("roleModal").classList.remove("show");
                selectedUserId = null;
            }

            async function confirmRoleChange() {
                const newRole = document.getElementById("newRoleSelect").value;
                try {
                    const res = await fetch(
                        `/api/admin/users/${selectedUserId}/role`,
                        {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ role: newRole }),
                        },
                    );

                    if (res.ok) {
                        alert(window.i18n.t("message.roleChangeSuccess"));
                        closeRoleModal();
                        loadUsers();
                    } else {
                        const error = await res.json();
                        alert("‚ùå " + error.error);
                    }
                } catch (e) {
                    console.error("Failed to change role:", e);
                    alert(window.i18n.t("message.actionError"));
                }
            }

            async function toggleUserStatus(userId, isActive) {
                const action = isActive
                    ? window.i18n.t("button.deactivate")
                    : window.i18n.t("button.activate");
                const confirmMsg = window.i18n
                    .t("message.confirmAction")
                    .replace("{action}", action.toLowerCase());
                if (!confirm(confirmMsg)) return;

                try {
                    const res = await fetch(
                        `/api/admin/users/${userId}/toggle-status`,
                        {
                            method: "PUT",
                        },
                    );

                    if (res.ok) {
                        const successMsg = window.i18n
                            .t("message.actionSuccess")
                            .replace("{action}", action);
                        alert(successMsg);
                        loadUsers();
                    } else {
                        const error = await res.json();
                        alert("‚ùå " + error.error);
                    }
                } catch (e) {
                    console.error("Failed to toggle status:", e);
                    alert(window.i18n.t("message.actionError"));
                }
            }

            // ===== Utilities =====
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return window.i18n.t("time.justNow");
                if (diffMins < 60)
                    return window.i18n
                        .t("time.minutesAgo")
                        .replace("{n}", diffMins);
                if (diffHours < 24)
                    return window.i18n
                        .t("time.hoursAgo")
                        .replace("{n}", diffHours);
                if (diffDays < 7)
                    return window.i18n
                        .t("time.daysAgo")
                        .replace("{n}", diffDays);

                const locale =
                    window.i18n.currentLang === "th" ? "th-TH" : "en-US";
                return date.toLocaleDateString(locale, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            function copyUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    alert(window.i18n.t("message.linkCopied"));
                });
            }

            // Search functionality
            document
                .getElementById("searchUrlInput")
                ?.addEventListener("input", (e) => {
                    const query = e.target.value.toLowerCase();
                    filteredUrls = allUrls.filter((url) => {
                        return (
                            url.code.toLowerCase().includes(query) ||
                            url.target.toLowerCase().includes(query) ||
                            (url.created_by &&
                                (url.created_by.name
                                    .toLowerCase()
                                    .includes(query) ||
                                    url.created_by.email
                                        .toLowerCase()
                                        .includes(query)))
                        );
                    });
                    renderUrlTable();
                });

            document
                .getElementById("searchUserInput")
                ?.addEventListener("input", (e) => {
                    const query = e.target.value.toLowerCase();
                    filteredUsers = allUsers.filter((user) => {
                        return (
                            user.name.toLowerCase().includes(query) ||
                            user.email.toLowerCase().includes(query)
                        );
                    });
                    renderUserTable();
                });

            // Initialize
            checkAuth();
        </script>
        <script src="navbar.js"></script>
        <script src="i18n.js"></script>
    </body>
</html>
