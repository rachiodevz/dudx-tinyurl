<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="showlink.title">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - DUDX URL Shortener</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/showlink.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <span class="brand-icon">üîó</span>
                DUDX
            </a>
            <div class="navbar-menu">
                <a href="/create" class="navbar-link" data-i18n="nav.create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå</a>
                <a href="/manage" class="navbar-link hidden" id="manageLink" data-i18n="nav.manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Å‡πå</a>
                <a href="/chat" class="navbar-link hidden" id="chatLink" data-i18n="nav.chat">üí¨ Chat</a>
                <button class="navbar-link hidden" id="logoutBtn" data-i18n="nav.logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                <a href="/login" class="navbar-link" id="loginLink" data-i18n="nav.login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                <div class="language-buttons">
                    <button class="lang-btn" data-lang="th">TH</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="success-header">
            <div class="success-icon">‚úÖ</div>
            <h1 data-i18n="showlink.success">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</h1>
        </div>

        <!-- Benefits Banner for Guests -->
        <div class="benefits-banner hidden" id="benefitsBanner">
            <h3 data-i18n="guest.benefitsTitle">üéÅ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©!</h3>
            <ul class="benefits-list">
                <li data-i18n="guest.benefit1">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</li>
                <li data-i18n="guest.benefit2">‚ú® ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</li>
                <li data-i18n="guest.benefit3">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° memo ‡πÑ‡∏î‡πâ</li>
                <li data-i18n="guest.benefit4">‚è∞ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</li>
                <li data-i18n="guest.benefit5">üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å</li>
            </ul>
            <button class="signup-btn" onclick="window.location.href='/auth/google'" data-i18n="guest.signupButton">
                ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ü‡∏£‡∏µ
            </button>
        </div>

        <!-- QR Code Section -->
        <div class="qr-section" id="qrSection">
            <h2 data-i18n="showlink.qrTitle">QR Code</h2>
            <div class="qr-container">
                <img id="qrImage" src="" alt="QR Code" />
            </div>
            <button class="btn-primary" id="downloadQRBtn" data-i18n="showlink.downloadQR">
                üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR Code
            </button>
        </div>

        <!-- Short Link Section -->
        <div class="link-section">
            <h2 data-i18n="showlink.linkTitle">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <div class="link-display">
                <input type="text" id="shortLinkInput" readonly />
                <button class="btn-copy" id="copyBtn" data-i18n="showlink.copy">
                    üìã Copy
                </button>
            </div>
            <div class="copy-feedback hidden" id="copyFeedback" data-i18n="showlink.copied">
                ‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-primary btn-large" onclick="window.location.href='/create'" data-i18n="showlink.createNew">
                ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Link ‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>

        <!-- Link Info (if available) -->
        <div class="link-info hidden" id="linkInfo">
            <h3 data-i18n="showlink.details">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
            <div class="info-item">
                <span class="info-label" data-i18n="showlink.targetUrl">URL ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</span>
                <span class="info-value" id="targetUrl"></span>
            </div>
            <div class="info-item">
                <span class="info-label" data-i18n="showlink.expiresAt">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</span>
                <span class="info-value" id="expiresAt"></span>
            </div>
            <div class="info-item hidden" id="memoItem">
                <span class="info-label" data-i18n="showlink.memo">Memo:</span>
                <span class="info-value" id="memoValue"></span>
            </div>
        </div>
    </div>

    <script type="module">
        import { translate, getCurrentLanguage, setupLanguageButtons } from '/i18n.js';

        let linkData = null;

        // Get code from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (!code) {
            window.location.href = '/create';
        }

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (data.isAuthenticated) {
                    document.getElementById('loginLink').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('manageLink').classList.remove('hidden');
                    document.getElementById('chatLink').classList.remove('hidden');
                } else {
                    // Show benefits banner for guests
                    document.getElementById('benefitsBanner').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking auth:', error);
            }
        }

        // Load link data
        async function loadLinkData() {
            try {
                const response = await fetch(`/api/link/${code}`);
                if (!response.ok) {
                    throw new Error('Link not found');
                }

                linkData = await response.json();

                // Display QR Code
                if (linkData.qrCode) {
                    document.getElementById('qrImage').src = linkData.qrCode;
                } else {
                    document.getElementById('qrSection').classList.add('hidden');
                }

                // Display short link
                const shortUrl = `${window.location.origin}/${linkData.code}`;
                document.getElementById('shortLinkInput').value = shortUrl;

                // Display link info
                if (linkData.target) {
                    document.getElementById('linkInfo').classList.remove('hidden');
                    document.getElementById('targetUrl').textContent = linkData.target;

                    if (linkData.expires_at) {
                        const expiryDate = new Date(linkData.expires_at);
                        document.getElementById('expiresAt').textContent = expiryDate.toLocaleDateString('th-TH');
                    } else {
                        document.getElementById('expiresAt').textContent = translate('showlink.noExpiry');
                    }

                    if (linkData.memo) {
                        document.getElementById('memoItem').classList.remove('hidden');
                        document.getElementById('memoValue').textContent = linkData.memo;
                    }
                }
            } catch (error) {
                console.error('Error loading link:', error);
                alert(translate('showlink.errorLoading'));
                window.location.href = '/create';
            }
        }

        // Copy to clipboard
        document.getElementById('copyBtn').addEventListener('click', async () => {
            const input = document.getElementById('shortLinkInput');
            try {
                await navigator.clipboard.writeText(input.value);
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.remove('hidden');
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 2000);
            } catch (error) {
                input.select();
                document.execCommand('copy');
            }
        });

        // Download QR Code
        document.getElementById('downloadQRBtn').addEventListener('click', () => {
            if (linkData && linkData.qrCode) {
                const link = document.createElement('a');
                link.href = linkData.qrCode;
                link.download = `DUDX-QR-${linkData.code}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Initialize
        setupLanguageButtons();
        translate();
        checkAuth();
        loadLinkData();
    </script>
</body>
</html>
