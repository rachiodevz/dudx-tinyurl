<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title data-i18n="chat.title">Chat - TinyURL</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/css/navbar.css" />
        <link rel="stylesheet" href="/css/chat.css" />
    </head>
    <body>
        <!-- Main Chat Container -->
        <div class="container hidden" id="chatPanel">
            <div class="header">
                <h1 data-i18n="chat.title">üí¨ Chat with AI</h1>
            </div>

            <div class="chat-container">
                <div class="messages" id="messages">
                    <div class="message bot">
                        <div class="message-content">
                            <p data-i18n="chat.welcome">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI Assistant ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö</p>
                        </div>
                    </div>
                </div>

                <div class="input-container">
                    <textarea
                        id="messageInput"
                        rows="3"
                        data-i18n-placeholder="chat.inputPlaceholder"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                    ></textarea>
                    <button id="sendBtn" data-i18n="chat.send">‡∏™‡πà‡∏á</button>
                </div>
            </div>
        </div>

        <!-- Login Screen -->
        <div class="login-container" id="loginContainer">
            <div class="lang-buttons">
                <button
                    onclick="window.i18n.setLang('th')"
                    id="langBtnTh"
                    class="lang-btn"
                >
                    TH
                </button>
                <button
                    onclick="window.i18n.setLang('en')"
                    id="langBtnEn"
                    class="lang-btn"
                >
                    EN
                </button>
            </div>
            <h2 data-i18n="login.welcome"></h2>
            <p data-i18n="login.pleaseLogin"></p>
            <button
                class="login-btn"
                onclick="window.location.href='/auth/google'"
            >
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path
                        fill="#4285F4"
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                    />
                    <path
                        fill="#34A853"
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
                    />
                    <path
                        fill="#FBBC05"
                        d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
                    />
                    <path
                        fill="#EA4335"
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                    />
                </svg>
                <span data-i18n="button.loginGoogle"></span>
            </button>
        </div>

        <script>
            const messageInput = document.getElementById("messageInput");
            const sendBtn = document.getElementById("sendBtn");
            const messagesContainer = document.getElementById("messages");
            const chatPanel = document.getElementById("chatPanel");
            const loginContainer = document.getElementById("loginContainer");

            // Check authentication
            async function checkAuth() {
                try {
                    // Wait for navbar to be ready
                    while (!window.navbar) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    const user = await window.navbar.checkAuth();

                    if (user) {
                        loginContainer.classList.add("hidden");
                        chatPanel.classList.remove("hidden");
                    } else {
                        loginContainer.classList.remove("hidden");
                        chatPanel.classList.add("hidden");
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    loginContainer.classList.remove("hidden");
                    chatPanel.classList.add("hidden");
                }
            }

            checkAuth();

            // Add message to chat
            function addMessage(content, isBot = false) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${isBot ? "bot" : "user"}`;

                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";
                contentDiv.textContent = content;

                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Send message
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                // Add user message
                addMessage(message, false);
                messageInput.value = "";
                sendBtn.disabled = true;

                try {
                    // Call API
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ message }),
                    });

                    const data = await response.json();

                    if (data.reply) {
                        addMessage(data.reply, true);
                    } else {
                        addMessage("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    addMessage("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
                } finally {
                    sendBtn.disabled = false;
                }
            }

            // Event listeners
            sendBtn.addEventListener("click", sendMessage);
            messageInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        </script>

        <script src="/navbar.js"></script>
        <script src="/i18n.js"></script>
    </body>
</html>
