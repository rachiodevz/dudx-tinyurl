<!doctype html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <title>Admin - TinyURL</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: system-ui, sans-serif;
                background: #f6f8fb;
                min-height: 100vh;
                padding: 20px;
            }
            .container {
                max-width: 1400px;
                margin: 0 auto;
            }
            .header {
                background: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .header h1 {
                font-size: 24px;
                color: #333;
            }
            .nav {
                display: flex;
                gap: 15px;
                align-items: center;
            }
            .nav a {
                color: #007bff;
                text-decoration: none;
                font-size: 14px;
                padding: 8px 15px;
                border-radius: 8px;
                transition: background 0.2s;
            }
            .nav a:hover {
                background: #f0f0f0;
            }
            .user-info {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px 15px;
                background: #f8f9fa;
                border-radius: 20px;
            }
            .user-photo {
                width: 32px;
                height: 32px;
                border-radius: 50%;
            }
            .logout-btn {
                background: #dc3545;
                color: white;
                padding: 8px 15px;
                font-size: 13px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            .logout-btn:hover {
                background: #c82333;
            }

            /* Tabs */
            .tabs {
                background: white;
                padding: 0;
                border-radius: 12px 12px 0 0;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                gap: 0;
                margin-bottom: -1px;
            }
            .tab-btn {
                padding: 15px 30px;
                border: none;
                background: transparent;
                cursor: pointer;
                font-size: 15px;
                font-weight: 500;
                color: #666;
                border-bottom: 3px solid transparent;
                transition: all 0.2s;
            }
            .tab-btn:hover {
                color: #007bff;
                background: #f8f9fa;
            }
            .tab-btn.active {
                color: #007bff;
                border-bottom-color: #007bff;
                background: white;
            }
            .tab-btn:first-child {
                border-radius: 12px 0 0 0;
            }
            .tab-btn:last-child {
                border-radius: 0 12px 0 0;
            }

            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            .stat-card {
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .stat-card h3 {
                font-size: 14px;
                color: #666;
                margin-bottom: 10px;
            }
            .stat-card .number {
                font-size: 32px;
                font-weight: bold;
                color: #007bff;
            }
            .content {
                background: white;
                padding: 30px;
                border-radius: 0 0 12px 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .search-box {
                margin-bottom: 20px;
            }
            .search-box input {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            thead {
                background: #f8f9fa;
            }
            th {
                padding: 12px;
                text-align: left;
                font-size: 13px;
                font-weight: 600;
                color: #666;
                border-bottom: 2px solid #dee2e6;
            }
            td {
                padding: 12px;
                font-size: 14px;
                border-bottom: 1px solid #dee2e6;
            }
            tr:hover {
                background: #f8f9fa;
            }
            .code-cell {
                font-family: "Courier New", monospace;
                min-width: 120px;
            }
            .url-cell {
                max-width: 300px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .url-cell a {
                color: #333;
                text-decoration: none;
            }
            .url-cell a:hover {
                text-decoration: underline;
            }
            .date-cell {
                color: #666;
                font-size: 13px;
            }
            .user-cell {
                font-size: 13px;
            }
            .user-name {
                font-weight: 500;
                color: #333;
            }
            .user-email {
                color: #666;
                font-size: 12px;
            }
            .copy-btn {
                background: #007bff;
                color: white;
                border: none;
                padding: 4px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            .copy-btn:hover {
                background: #0056b3;
            }

            /* User Management Styles */
            .role-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }
            .role-user {
                background: #e3f2fd;
                color: #1976d2;
            }
            .role-admin {
                background: #fff3e0;
                color: #f57c00;
            }
            .role-superadmin {
                background: #fce4ec;
                color: #c2185b;
            }
            .status-active {
                color: #28a745;
                font-weight: 600;
            }
            .status-inactive {
                color: #dc3545;
                font-weight: 600;
            }
            .action-btn {
                padding: 6px 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                margin-right: 5px;
            }
            .btn-toggle {
                background: #ffc107;
                color: #000;
            }
            .btn-toggle:hover {
                background: #ffb300;
            }
            .btn-role {
                background: #17a2b8;
                color: white;
            }
            .btn-role:hover {
                background: #138496;
            }
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }
            .modal.show {
                display: flex;
            }
            .modal-content {
                background: white;
                padding: 30px;
                border-radius: 12px;
                max-width: 400px;
                width: 90%;
            }
            .modal-content h3 {
                margin-bottom: 20px;
            }
            .modal-actions {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                justify-content: flex-end;
            }
            .btn-cancel {
                background: #6c757d;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
            }
            .btn-confirm {
                background: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
            }
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }
            .empty {
                text-align: center;
                padding: 40px;
                color: #999;
            }
            .login-container {
                max-width: 400px;
                margin: 100px auto;
                background: white;
                padding: 40px;
                border-radius: 16px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .login-btn {
                background: white;
                color: #333;
                padding: 12px 24px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 8px;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .login-btn:hover {
                background: #f8f9fa;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <!-- Login Screen -->
        <div class="login-container hidden" id="loginContainer">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
            <p style="margin: 20px 0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Admin</p>
            <button
                class="login-btn"
                onclick="window.location.href='/auth/google'"
            >
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path
                        fill="#4285F4"
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                    />
                    <path
                        fill="#34A853"
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
                    />
                    <path
                        fill="#FBBC05"
                        d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
                    />
                    <path
                        fill="#EA4335"
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                    />
                </svg>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>

        <!-- Main Admin Panel -->
        <div class="container hidden" id="adminPanel">
            <div class="header">
                <h1>üìä Admin Panel - TinyURL</h1>
                <div class="nav">
                    <a href="/">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
                    <a href="/my-urls">üîó URL ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
                    <div class="user-info">
                        <img class="user-photo" id="userPhoto" src="" alt="" />
                        <span id="userName"></span>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('urls')">
                    üîó URL Management
                </button>
                <button class="tab-btn" onclick="switchTab('users')">
                    üë• User Management
                </button>
            </div>

            <!-- URLs Tab -->
            <div class="tab-content active" id="urlsTab">
                <div class="stats">
                    <div class="stat-card">
                        <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô URL ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div class="number" id="totalUrls">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <div class="number" id="todayUrls">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div class="number" id="totalUsers">0</div>
                    </div>
                </div>

                <div class="content">
                    <div class="search-box">
                        <input
                            type="text"
                            id="searchUrlInput"
                            placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ URL, ‡∏£‡∏´‡∏±‡∏™, ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á..."
                        />
                    </div>
                    <div id="urlTableContainer">
                        <div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-content" id="usersTab">
                <div class="stats">
                    <div class="stat-card">
                        <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div class="number" id="totalUsersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="number" id="activeUsersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Admins</h3>
                        <div class="number" id="adminCount">0</div>
                    </div>
                </div>

                <div class="content">
                    <div class="search-box">
                        <input
                            type="text"
                            id="searchUserInput"
                            placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..."
                        />
                    </div>
                    <div id="userTableContainer">
                        <div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Role Modal -->
        <div class="modal" id="roleModal">
            <div class="modal-content">
                <h3>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role</h3>
                <div class="form-group">
                    <label>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                    <div
                        id="modalUserName"
                        style="font-weight: 500; margin-bottom: 10px"
                    ></div>
                </div>
                <div class="form-group">
                    <label>Role ‡πÉ‡∏´‡∏°‡πà:</label>
                    <select id="newRoleSelect">
                        <option value="USER">User</option>
                        <option value="ADMIN">Admin</option>
                        <option value="SUPER_ADMIN">Super Admin</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeRoleModal()">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button class="btn-confirm" onclick="confirmRoleChange()">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                </div>
            </div>
        </div>

        <script>
            let allUrls = [];
            let filteredUrls = [];
            let allUsers = [];
            let filteredUsers = [];
            let currentUser = null;
            let selectedUserId = null;

            // Check authentication
            async function checkAuth() {
                try {
                    const res = await fetch("/auth/user");
                    if (res.ok) {
                        currentUser = await res.json();
                        document
                            .getElementById("loginContainer")
                            .classList.add("hidden");
                        document
                            .getElementById("adminPanel")
                            .classList.remove("hidden");
                        document.getElementById("userName").textContent =
                            currentUser.name;
                        document.getElementById("userPhoto").src =
                            currentUser.photo;
                        loadUrls();
                        loadUsers();
                    } else {
                        document
                            .getElementById("loginContainer")
                            .classList.remove("hidden");
                        document
                            .getElementById("adminPanel")
                            .classList.add("hidden");
                    }
                } catch (e) {
                    console.error("Auth check failed:", e);
                    document
                        .getElementById("loginContainer")
                        .classList.remove("hidden");
                    document
                        .getElementById("adminPanel")
                        .classList.add("hidden");
                }
            }

            // Logout
            document
                .getElementById("logoutBtn")
                ?.addEventListener("click", () => {
                    window.location.href = "/auth/logout";
                });

            // Switch tabs
            function switchTab(tab) {
                const tabs = ["urls", "users"];
                tabs.forEach((t) => {
                    document
                        .getElementById(t + "Tab")
                        .classList.remove("active");
                });
                document.getElementById(tab + "Tab").classList.add("active");

                const btns = document.querySelectorAll(".tab-btn");
                btns.forEach((btn) => btn.classList.remove("active"));
                event.target.classList.add("active");
            }

            // ===== URLs Management =====
            async function loadUrls() {
                try {
                    const res = await fetch("/api/urls");
                    if (res.ok) {
                        allUrls = await res.json();
                        filteredUrls = allUrls;
                        updateUrlStats();
                        renderUrlTable();
                    } else {
                        document.getElementById("urlTableContainer").innerHTML =
                            '<div class="empty">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
                    }
                } catch (e) {
                    console.error("Failed to load URLs:", e);
                    document.getElementById("urlTableContainer").innerHTML =
                        '<div class="empty">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                }
            }

            function updateUrlStats() {
                const total = allUrls.length;
                const today = allUrls.filter((url) => {
                    const created = new Date(url.created_at);
                    const now = new Date();
                    return (
                        created.getDate() === now.getDate() &&
                        created.getMonth() === now.getMonth() &&
                        created.getFullYear() === now.getFullYear()
                    );
                }).length;

                const uniqueUsers = new Set(
                    allUrls
                        .filter((url) => url.created_by)
                        .map((url) => url.created_by.id),
                ).size;

                document.getElementById("totalUrls").textContent = total;
                document.getElementById("todayUrls").textContent = today;
                document.getElementById("totalUsers").textContent = uniqueUsers;
            }

            function renderUrlTable() {
                const container = document.getElementById("urlTableContainer");
                if (filteredUrls.length === 0) {
                    container.innerHTML =
                        '<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• URL</div>';
                    return;
                }

                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Short Link</th>
                                <th>URL ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                                <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                <th>‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                <th>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUrls
                                .map(
                                    (url) => `
                                <tr>
                                    <td class="code-cell">
                                        <a href="${window.location.origin}/${url.code}" target="_blank"
                                           style="color: #007bff; text-decoration: none; font-weight: 600;">
                                            üîó ${url.code}
                                        </a>
                                    </td>
                                    <td class="url-cell">
                                        <a href="${url.target}" target="_blank" title="${url.target}">
                                            ${url.target}
                                        </a>
                                    </td>
                                    <td class="date-cell">${url.memo || "-"}</td>
                                    <td class="user-cell">
                                        ${
                                            url.created_by
                                                ? `
                                            <div class="user-name">${url.created_by.name}</div>
                                            <div class="user-email">${url.created_by.email}</div>
                                        `
                                                : '<span style="color: #999">-</span>'
                                        }
                                    </td>
                                    <td class="date-cell">${formatDate(url.created_at)}</td>
                                    <td>
                                        <button class="copy-btn" onclick="copyUrl('${window.location.origin}/${url.code}')">
                                            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                                        </button>
                                    </td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;
                container.innerHTML = table;
            }

            // ===== User Management =====
            async function loadUsers() {
                try {
                    const res = await fetch("/api/admin/users");
                    if (res.ok) {
                        allUsers = await res.json();
                        filteredUsers = allUsers;
                        updateUserStats();
                        renderUserTable();
                    } else {
                        document.getElementById(
                            "userTableContainer",
                        ).innerHTML =
                            '<div class="empty">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</div>';
                    }
                } catch (e) {
                    console.error("Failed to load users:", e);
                    document.getElementById("userTableContainer").innerHTML =
                        '<div class="empty">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                }
            }

            function updateUserStats() {
                const total = allUsers.length;
                const active = allUsers.filter((u) => u.isActive).length;
                const admins = allUsers.filter(
                    (u) => u.role === "ADMIN" || u.role === "SUPER_ADMIN",
                ).length;

                document.getElementById("totalUsersCount").textContent = total;
                document.getElementById("activeUsersCount").textContent =
                    active;
                document.getElementById("adminCount").textContent = admins;
            }

            function renderUserTable() {
                const container = document.getElementById("userTableContainer");
                if (filteredUsers.length === 0) {
                    container.innerHTML =
                        '<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>';
                    return;
                }

                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                <th>Role</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUsers
                                .map(
                                    (user) => `
                                <tr>
                                    <td class="user-cell">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="${user.photo}" alt="" style="width: 32px; height: 32px; border-radius: 50%;">
                                            <div class="user-name">${user.name}</div>
                                        </div>
                                    </td>
                                    <td>${user.email}</td>
                                    <td>
                                        <span class="role-badge role-${user.role.toLowerCase().replace("_", "")}">
                                            ${user.role === "SUPER_ADMIN" ? "Super Admin" : user.role === "ADMIN" ? "Admin" : "User"}
                                        </span>
                                    </td>
                                    <td class="${user.isActive ? "status-active" : "status-inactive"}">
                                        ${user.isActive ? "‚úÖ Active" : "‚ùå Inactive"}
                                    </td>
                                    <td class="date-cell">${user.lastLogin ? formatDate(user.lastLogin) : "-"}</td>
                                    <td>
                                        ${
                                            user.googleId !== currentUser.id
                                                ? `
                                            <button class="action-btn btn-role" onclick="openRoleModal('${user.googleId}', '${user.name}', '${user.role}')">
                                                ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role
                                            </button>
                                            <button class="action-btn btn-toggle" onclick="toggleUserStatus('${user.googleId}', ${user.isActive})">
                                                ${user.isActive ? "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"}
                                            </button>
                                        `
                                                : '<span style="color: #999;">-</span>'
                                        }
                                    </td>
                                </tr>
                            `,
                                )
                                .join("")}
                        </tbody>
                    </table>
                `;
                container.innerHTML = table;
            }

            function openRoleModal(userId, userName, currentRole) {
                selectedUserId = userId;
                document.getElementById("modalUserName").textContent = userName;
                document.getElementById("newRoleSelect").value = currentRole;
                document.getElementById("roleModal").classList.add("show");
            }

            function closeRoleModal() {
                document.getElementById("roleModal").classList.remove("show");
                selectedUserId = null;
            }

            async function confirmRoleChange() {
                const newRole = document.getElementById("newRoleSelect").value;
                try {
                    const res = await fetch(
                        `/api/admin/users/${selectedUserId}/role`,
                        {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ role: newRole }),
                        },
                    );

                    if (res.ok) {
                        alert("‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                        closeRoleModal();
                        loadUsers();
                    } else {
                        const error = await res.json();
                        alert("‚ùå " + error.error);
                    }
                } catch (e) {
                    console.error("Failed to change role:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                }
            }

            async function toggleUserStatus(userId, isActive) {
                const action = isActive ? "‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£${action}‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

                try {
                    const res = await fetch(
                        `/api/admin/users/${userId}/toggle-status`,
                        {
                            method: "PUT",
                        },
                    );

                    if (res.ok) {
                        alert(`‚úÖ ${action}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                        loadUsers();
                    } else {
                        const error = await res.json();
                        alert("‚ùå " + error.error);
                    }
                } catch (e) {
                    console.error("Failed to toggle status:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                }
            }

            // ===== Utilities =====
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
                if (diffMins < 60) return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffHours < 24) return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                if (diffDays < 7) return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;

                return date.toLocaleDateString("th-TH", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            function copyUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    alert("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!");
                });
            }

            // Search functionality
            document
                .getElementById("searchUrlInput")
                ?.addEventListener("input", (e) => {
                    const query = e.target.value.toLowerCase();
                    filteredUrls = allUrls.filter((url) => {
                        return (
                            url.code.toLowerCase().includes(query) ||
                            url.target.toLowerCase().includes(query) ||
                            (url.created_by &&
                                (url.created_by.name
                                    .toLowerCase()
                                    .includes(query) ||
                                    url.created_by.email
                                        .toLowerCase()
                                        .includes(query)))
                        );
                    });
                    renderUrlTable();
                });

            document
                .getElementById("searchUserInput")
                ?.addEventListener("input", (e) => {
                    const query = e.target.value.toLowerCase();
                    filteredUsers = allUsers.filter((user) => {
                        return (
                            user.name.toLowerCase().includes(query) ||
                            user.email.toLowerCase().includes(query)
                        );
                    });
                    renderUserTable();
                });

            // Initialize
            checkAuth();
        </script>
    </body>
</html>
